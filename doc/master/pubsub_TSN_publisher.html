<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Realtime Publish Example &mdash; open62541 1.2.2-unknown documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="_static/graphviz.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="_static/doctools.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Realtime Loopback Example" href="pubsub_TSN_loopback.html" />
    <link rel="prev" title="Subscribing Fields" href="tutorial_pubsub_subscribe.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="toc.html" class="icon icon-home"> open62541
            <img src="_static/open62541_html.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                1.2
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="index.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="building.html">Building open62541</a></li>
<li class="toctree-l1"><a class="reference internal" href="installing.html">Installing open62541</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="tutorials.html">Tutorials</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="tutorial_datatypes.html">Working with Data Types</a></li>
<li class="toctree-l2"><a class="reference internal" href="tutorial_server_firststeps.html">Building a Simple Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="tutorial_server_variable.html">Adding Variables to a Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="tutorial_server_datasource.html">Connecting a Variable with a Physical Process</a></li>
<li class="toctree-l2"><a class="reference internal" href="tutorial_server_variabletype.html">Working with Variable Types</a></li>
<li class="toctree-l2"><a class="reference internal" href="tutorial_server_object.html">Working with Objects and Object Types</a></li>
<li class="toctree-l2"><a class="reference internal" href="tutorial_server_method.html">Adding Methods to Objects</a></li>
<li class="toctree-l2"><a class="reference internal" href="tutorial_server_monitoreditems.html">Observing Attributes with Local MonitoredItems</a></li>
<li class="toctree-l2"><a class="reference internal" href="tutorial_server_events.html">Generating events</a></li>
<li class="toctree-l2"><a class="reference internal" href="tutorial_server_alarms_conditions.html">Using Alarms and Conditions Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="tutorial_client_firststeps.html">Building a Simple Client</a></li>
<li class="toctree-l2"><a class="reference internal" href="tutorial_pubsub_publish.html">Working with Publish/Subscribe</a></li>
<li class="toctree-l2"><a class="reference internal" href="tutorial_pubsub_subscribe.html">Subscribing Fields</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Realtime Publish Example</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#csv-file-handling">CSV file handling</a></li>
<li class="toctree-l3"><a class="reference internal" href="#external-data-source-handling">External data source handling</a></li>
<li class="toctree-l3"><a class="reference internal" href="#subscriber">Subscriber</a></li>
<li class="toctree-l3"><a class="reference internal" href="#publisher">Publisher</a></li>
<li class="toctree-l3"><a class="reference internal" href="#published-data-handling">Published data handling</a></li>
<li class="toctree-l3"><a class="reference internal" href="#subscribed-data-handling">Subscribed data handling</a></li>
<li class="toctree-l3"><a class="reference internal" href="#publisher-thread-routine">Publisher thread routine</a></li>
<li class="toctree-l3"><a class="reference internal" href="#subscriber-thread-routine">Subscriber thread routine</a></li>
<li class="toctree-l3"><a class="reference internal" href="#userapplication-thread-routine">UserApplication thread routine</a></li>
<li class="toctree-l3"><a class="reference internal" href="#thread-creation">Thread creation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#creation-of-nodes">Creation of nodes</a></li>
<li class="toctree-l3"><a class="reference internal" href="#deletion-of-nodes">Deletion of nodes</a></li>
<li class="toctree-l3"><a class="reference internal" href="#time-difference-calculation">Time Difference Calculation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#latency-calculation">Latency Calculation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#usage-function">Usage function</a></li>
<li class="toctree-l3"><a class="reference internal" href="#main-server-code">Main Server code</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="pubsub_TSN_loopback.html">Realtime Loopback Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="pubsub_nodeset_rt_publisher.html">Publisher Realtime example using custom nodes</a></li>
<li class="toctree-l2"><a class="reference internal" href="pubsub_nodeset_rt_subscriber.html">Subscriber Realtime example using custom nodes</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="protocol.html">Protocol</a></li>
<li class="toctree-l1"><a class="reference internal" href="types.html">Data Types</a></li>
<li class="toctree-l1"><a class="reference internal" href="services.html">Services</a></li>
<li class="toctree-l1"><a class="reference internal" href="nodestore.html">Information Modelling</a></li>
<li class="toctree-l1"><a class="reference internal" href="nodestore.html#node-pointer">Node Pointer</a></li>
<li class="toctree-l1"><a class="reference internal" href="server.html">Server</a></li>
<li class="toctree-l1"><a class="reference internal" href="client.html">Client</a></li>
<li class="toctree-l1"><a class="reference internal" href="pubsub.html">PubSub</a></li>
<li class="toctree-l1"><a class="reference internal" href="common.html">Common Definitions</a></li>
<li class="toctree-l1"><a class="reference internal" href="nodeset_compiler.html">XML Nodeset Compiler</a></li>
<li class="toctree-l1"><a class="reference internal" href="internal.html">Internals</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="toc.html">open62541</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="toc.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="tutorials.html">Tutorials</a> &raquo;</li>
      <li>Realtime Publish Example</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/pubsub_TSN_publisher.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="realtime-publish-example">
<span id="pubsub-tsn-publisher"></span><h1>Realtime Publish Example<a class="headerlink" href="#realtime-publish-example" title="Permalink to this heading">¶</a></h1>
<p>This tutorial shows publishing and subscribing information in Realtime. This
example has both Publisher and Subscriber(used as threads, running in same
core), the Publisher thread publishes counterdata (an incremental data), that
is subscribed by the Subscriber thread of pubsub_TSN_loopback.c example. The
Publisher thread of pusbub_TSN_loopback.c publishes the received counterdata,
which is subscribed by the Subscriber thread of this example. Thus a
round-trip of counterdata is achieved. In a realtime system, the round-trip
time of the counterdata is 4x cycletime, in this example, the round-trip time
is 1ms. The flow of this communication and the trace points are given in the
diagram below.</p>
<p>Another thread called the UserApplication thread is also used in the example,
which serves the functionality of the Control loop. In this example,
UserApplication threads increments the counterData, which is published by the
Publisher thread and also reads the subscribed data from the Information
Model and writes the updated counterdata into distinct csv files during each
cycle. Buffered Network Message will be used for publishing and subscribing
in the RT path. Further, DataSetField will be accessed via direct pointer
access between the user interface and the Information Model.</p>
<p>Another additional feature called the Blocking Socket is employed in the
Subscriber thread. This feature is optional and can be enabled or disabled
when running application by using command line argument
“-enableBlockingSocket”. When using Blocking Socket, the Subscriber thread
remains in “blocking mode” until a message is received from every wake up
time of the thread. In other words, the timeout is overwritten and the thread
continuously waits for the message from every wake up time of the thread.
Once the message is received, the Subscriber thread updates the value in the
Information Model, sleeps up to wake up time and again waits for the next
message. This process is repeated until the application is terminated.</p>
<p>To ensure realtime capabilities, Publisher uses ETF(Earliest Tx-time First)
to publish information at the calculated tranmission time over Ethernet.
Subscriber can be used with or without XDP(Xpress Data Processing) over
Ethernet</p>
<p>Run step of the example is as mentioned below:</p>
<p><code class="docutils literal notranslate"><span class="pre">./bin/examples/pubsub_TSN_publisher</span> <span class="pre">-interface</span> <span class="pre">&lt;interface&gt;</span></code></p>
<p>For more options, run ./bin/examples/pubsub_TSN_publisher -help</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/*  Trace point setup</span>
<span class="cm"> *</span>
<span class="cm"> *             +--------------+                  +----------------+</span>
<span class="cm"> *          T1 | OPCUA PubSub |  T8           T5 | OPCUA loopback |  T4</span>
<span class="cm"> *          |  |  Application |  ^            |  |  Application   |  ^</span>
<span class="cm"> *          |  +--------------+  |            |  +----------------+  |</span>
<span class="cm"> *   User   |  |              |  |            |  |                |  |</span>
<span class="cm"> *   Space  |  |              |  |            |  |                |  |</span>
<span class="cm"> *          |  |              |  |            |  |                |  |</span>
<span class="cm"> *  -----------|--------------|------------------|----------------|--------</span>
<span class="cm"> *          |  |    Node 1    |  |            |  |     Node 2     |  |</span>
<span class="cm"> *   Kernel |  |              |  |            |  |                |  |</span>
<span class="cm"> *   Space  |  |              |  |            |  |                |  |</span>
<span class="cm"> *          |  |              |  |            |  |                |  |</span>
<span class="cm"> *          v  +--------------+  |            v  +----------------+  |</span>
<span class="cm"> *          T2 |  TX tcpdump  |  T7&lt;----------T6 |   RX tcpdump   |  T3</span>
<span class="cm"> *          |  +--------------+                  +----------------+  ^</span>
<span class="cm"> *          |                                                        |</span>
<span class="cm"> *          ----------------------------------------------------------</span>
<span class="cm"> */</span><span class="w"></span>

<span class="cp">#define _GNU_SOURCE</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;sched.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;signal.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;time.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;linux/types.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;sys/io.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;getopt.h&gt;</span><span class="cp"></span>

<span class="cm">/* For thread operations */</span><span class="w"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pthread.h&gt;</span><span class="cp"></span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;open62541/server.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;open62541/server_config_default.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;open62541/plugin/log_stdout.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;open62541/plugin/log.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;open62541/types_generated.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;open62541/plugin/pubsub_ethernet.h&gt;</span><span class="cp"></span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;open62541/plugin/securitypolicy_default.h&gt;</span><span class="cp"></span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;ua_pubsub.h&quot;</span><span class="cp"></span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;linux/if_link.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;linux/if_xdp.h&gt;</span><span class="cp"></span>

<span class="n">UA_NodeId</span><span class="w"> </span><span class="n">readerGroupIdentifier</span><span class="p">;</span><span class="w"></span>
<span class="n">UA_NodeId</span><span class="w"> </span><span class="n">readerIdentifier</span><span class="p">;</span><span class="w"></span>

<span class="n">UA_DataSetReaderConfig</span><span class="w"> </span><span class="n">readerConfig</span><span class="p">;</span><span class="w"></span>

<span class="cm">/* to find load of each thread</span>
<span class="cm"> * ps -L -o pid,pri,%cpu -C pubsub_TSN_publisher */</span><span class="w"></span>

<span class="cm">/* Configurable Parameters */</span><span class="w"></span>
<span class="cm">/* These defines enables the publisher and subscriber of the OPCUA stack */</span><span class="w"></span>
<span class="cm">/* To run only publisher, enable PUBLISHER define alone (comment SUBSCRIBER) */</span><span class="w"></span>
<span class="cp">#define             PUBLISHER</span>
<span class="cm">/* To run only subscriber, enable SUBSCRIBER define alone (comment PUBLISHER) */</span><span class="w"></span>
<span class="cp">#define             SUBSCRIBER</span>
<span class="cm">/* Cycle time in milliseconds */</span><span class="w"></span>
<span class="cp">#define             DEFAULT_CYCLE_TIME                    0.25</span>
<span class="cm">/* Qbv offset */</span><span class="w"></span>
<span class="cp">#define             DEFAULT_QBV_OFFSET                    125</span>
<span class="cp">#define             DEFAULT_SOCKET_PRIORITY               3</span>
<span class="cp">#if defined(PUBLISHER)</span>
<span class="cp">#define             PUBLISHER_ID                          2234</span>
<span class="cp">#define             WRITER_GROUP_ID                       101</span>
<span class="cp">#define             DATA_SET_WRITER_ID                    62541</span>
<span class="cp">#define             DEFAULT_PUBLISHING_MAC_ADDRESS        &quot;opc.eth:</span><span class="c1">//01-00-5E-7F-00-01:8.3&quot;</span>
<span class="cp">#endif</span>
<span class="cp">#define             PUBLISHER_ID_SUB                      2235</span>
<span class="cp">#define             WRITER_GROUP_ID_SUB                   100</span>
<span class="cp">#define             DATA_SET_WRITER_ID_SUB                62541</span>
<span class="cp">#define             DEFAULT_SUBSCRIBING_MAC_ADDRESS       &quot;opc.eth:</span><span class="c1">//01-00-5E-00-00-01:8.3&quot;</span>
<span class="cp">#define             REPEATED_NODECOUNTS                   2    </span><span class="c1">// Default to publish 64 bytes</span>
<span class="cp">#define             PORT_NUMBER                           62541</span>
<span class="cp">#define             DEFAULT_XDP_QUEUE                     2</span>
<span class="cp">#define             PUBSUB_CONFIG_RT_INFORMATION_MODEL</span>

<span class="cm">/* Non-Configurable Parameters */</span><span class="w"></span>
<span class="cm">/* Milli sec and sec conversion to nano sec */</span><span class="w"></span>
<span class="cp">#define             MILLI_SECONDS                         1000 * 1000</span>
<span class="cp">#define             SECONDS                               1000 * 1000 * 1000</span>
<span class="cp">#define             SECONDS_SLEEP                         5</span>
<span class="cm">/* Publisher will sleep for 60% of cycle time and then prepares the */</span><span class="w"></span>
<span class="cm">/* transmission packet within 40% */</span><span class="w"></span>
<span class="k">static</span><span class="w"> </span><span class="n">UA_Double</span><span class="w">  </span><span class="n">pubWakeupPercentage</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="mf">0.6</span><span class="p">;</span><span class="w"></span>
<span class="cp">#if defined(SUBSCRIBER)</span>
<span class="cm">/* Subscriber will wakeup only during start of cycle and check whether */</span><span class="w"></span>
<span class="cm">/* the packets are received */</span><span class="w"></span>
<span class="k">static</span><span class="w"> </span><span class="n">UA_Double</span><span class="w">  </span><span class="n">subWakeupPercentage</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="cm">/* User application Pub/Sub will wakeup at the 30% of cycle time and handles the */</span><span class="w"></span>
<span class="cm">/* user data such as read and write in Information model */</span><span class="w"></span>
<span class="k">static</span><span class="w"> </span><span class="n">UA_Double</span><span class="w">  </span><span class="n">userAppWakeupPercentage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.3</span><span class="p">;</span><span class="w"></span>
<span class="cm">/* Priority of Publisher, Subscriber, User application and server are kept */</span><span class="w"></span>
<span class="cm">/* after some prototyping and analyzing it */</span><span class="w"></span>
<span class="cp">#define             DEFAULT_PUB_SCHED_PRIORITY              78</span>
<span class="cp">#define             DEFAULT_SUB_SCHED_PRIORITY              81</span>
<span class="cp">#define             DEFAULT_USERAPPLICATION_SCHED_PRIORITY  75</span>
<span class="cp">#define             MAX_MEASUREMENTS                        1000000</span>
<span class="cp">#define             MAX_MEASUREMENTS_FILEWRITE              100000000</span>
<span class="cp">#define             DEFAULT_PUB_CORE                        2</span>
<span class="cp">#define             DEFAULT_SUB_CORE                        2</span>
<span class="cp">#define             DEFAULT_USER_APP_CORE                   3</span>
<span class="cp">#define             SECONDS_INCREMENT                       1</span>
<span class="cp">#ifndef CLOCK_TAI</span>
<span class="cp">#define             CLOCK_TAI                               11</span>
<span class="cp">#endif</span>
<span class="cp">#define             CLOCKID                                 CLOCK_TAI</span>
<span class="cp">#define             ETH_TRANSPORT_PROFILE                   &quot;http:</span><span class="c1">//opcfoundation.org/UA-Profile/Transport/pubsub-eth-uadp&quot;</span>
<span class="cp">#define             LATENCY_CSV_FILE_NAME                   &quot;latencyT1toT8.csv&quot;</span>

<span class="cp">#ifdef UA_ENABLE_PUBSUB_ENCRYPTION</span>
<span class="cp">#define             UA_AES128CTR_SIGNING_KEY_LENGTH          32</span>
<span class="cp">#define             UA_AES128CTR_KEY_LENGTH                  16</span>
<span class="cp">#define             UA_AES128CTR_KEYNONCE_LENGTH             4</span>

<span class="cp">#if defined(PUBLISHER)</span>
<span class="n">UA_Byte</span><span class="w"> </span><span class="n">signingKeyPub</span><span class="p">[</span><span class="n">UA_AES128CTR_SIGNING_KEY_LENGTH</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span><span class="w"></span>
<span class="n">UA_Byte</span><span class="w"> </span><span class="n">encryptingKeyPub</span><span class="p">[</span><span class="n">UA_AES128CTR_KEY_LENGTH</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span><span class="w"></span>
<span class="n">UA_Byte</span><span class="w"> </span><span class="n">keyNoncePub</span><span class="p">[</span><span class="n">UA_AES128CTR_KEYNONCE_LENGTH</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span><span class="w"></span>
<span class="cp">#endif</span>

<span class="cp">#if defined(SUBSCRIBER)</span>
<span class="n">UA_Byte</span><span class="w"> </span><span class="n">signingKeySub</span><span class="p">[</span><span class="n">UA_AES128CTR_SIGNING_KEY_LENGTH</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span><span class="w"></span>
<span class="n">UA_Byte</span><span class="w"> </span><span class="n">encryptingKeySub</span><span class="p">[</span><span class="n">UA_AES128CTR_KEY_LENGTH</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span><span class="w"></span>
<span class="n">UA_Byte</span><span class="w"> </span><span class="n">keyNonceSub</span><span class="p">[</span><span class="n">UA_AES128CTR_KEYNONCE_LENGTH</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="cp">#endif</span>

<span class="cm">/* If the Hardcoded publisher/subscriber MAC addresses need to be changed,</span>
<span class="cm"> * change PUBLISHING_MAC_ADDRESS and SUBSCRIBING_MAC_ADDRESS</span>
<span class="cm"> */</span><span class="w"></span>

<span class="cm">/* Set server running as true */</span><span class="w"></span>
<span class="n">UA_Boolean</span><span class="w">        </span><span class="n">runningServer</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="kt">char</span><span class="o">*</span><span class="w">             </span><span class="n">pubMacAddress</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="n">DEFAULT_PUBLISHING_MAC_ADDRESS</span><span class="p">;</span><span class="w"></span>
<span class="kt">char</span><span class="o">*</span><span class="w">             </span><span class="n">subMacAddress</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="n">DEFAULT_SUBSCRIBING_MAC_ADDRESS</span><span class="p">;</span><span class="w"></span>
<span class="k">static</span><span class="w"> </span><span class="n">UA_Double</span><span class="w">  </span><span class="n">cycleTimeInMsec</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="n">DEFAULT_CYCLE_TIME</span><span class="p">;</span><span class="w"></span>
<span class="k">static</span><span class="w"> </span><span class="n">UA_Int32</span><span class="w">   </span><span class="n">socketPriority</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="n">DEFAULT_SOCKET_PRIORITY</span><span class="p">;</span><span class="w"></span>
<span class="k">static</span><span class="w"> </span><span class="n">UA_Int32</span><span class="w">   </span><span class="n">pubPriority</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="n">DEFAULT_PUB_SCHED_PRIORITY</span><span class="p">;</span><span class="w"></span>
<span class="k">static</span><span class="w"> </span><span class="n">UA_Int32</span><span class="w">   </span><span class="n">subPriority</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="n">DEFAULT_SUB_SCHED_PRIORITY</span><span class="p">;</span><span class="w"></span>
<span class="k">static</span><span class="w"> </span><span class="n">UA_Int32</span><span class="w">   </span><span class="n">userAppPriority</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="n">DEFAULT_USERAPPLICATION_SCHED_PRIORITY</span><span class="p">;</span><span class="w"></span>
<span class="k">static</span><span class="w"> </span><span class="n">UA_Int32</span><span class="w">   </span><span class="n">pubCore</span><span class="w">              </span><span class="o">=</span><span class="w"> </span><span class="n">DEFAULT_PUB_CORE</span><span class="p">;</span><span class="w"></span>
<span class="k">static</span><span class="w"> </span><span class="n">UA_Int32</span><span class="w">   </span><span class="n">subCore</span><span class="w">              </span><span class="o">=</span><span class="w"> </span><span class="n">DEFAULT_SUB_CORE</span><span class="p">;</span><span class="w"></span>
<span class="k">static</span><span class="w"> </span><span class="n">UA_Int32</span><span class="w">   </span><span class="n">userAppCore</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="n">DEFAULT_USER_APP_CORE</span><span class="p">;</span><span class="w"></span>
<span class="k">static</span><span class="w"> </span><span class="n">UA_Int32</span><span class="w">   </span><span class="n">qbvOffset</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="n">DEFAULT_QBV_OFFSET</span><span class="p">;</span><span class="w"></span>
<span class="k">static</span><span class="w"> </span><span class="n">UA_UInt32</span><span class="w">  </span><span class="n">xdpQueue</span><span class="w">             </span><span class="o">=</span><span class="w"> </span><span class="n">DEFAULT_XDP_QUEUE</span><span class="p">;</span><span class="w"></span>
<span class="k">static</span><span class="w"> </span><span class="n">UA_UInt32</span><span class="w">  </span><span class="n">xdpFlag</span><span class="w">              </span><span class="o">=</span><span class="w"> </span><span class="n">XDP_FLAGS_SKB_MODE</span><span class="p">;</span><span class="w"></span>
<span class="k">static</span><span class="w"> </span><span class="n">UA_UInt32</span><span class="w">  </span><span class="n">xdpBindFlag</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="n">XDP_COPY</span><span class="p">;</span><span class="w"></span>
<span class="k">static</span><span class="w"> </span><span class="n">UA_Boolean</span><span class="w"> </span><span class="n">disableSoTxtime</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="k">static</span><span class="w"> </span><span class="n">UA_Boolean</span><span class="w"> </span><span class="n">enableCsvLog</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="k">static</span><span class="w"> </span><span class="n">UA_Boolean</span><span class="w"> </span><span class="n">enableLatencyCsvLog</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="k">static</span><span class="w"> </span><span class="n">UA_Boolean</span><span class="w"> </span><span class="n">consolePrint</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="k">static</span><span class="w"> </span><span class="n">UA_Boolean</span><span class="w"> </span><span class="n">enableBlockingSocket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="k">static</span><span class="w"> </span><span class="n">UA_Boolean</span><span class="w"> </span><span class="n">signalTerm</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="k">static</span><span class="w"> </span><span class="n">UA_Boolean</span><span class="w"> </span><span class="n">enableXdpSubscribe</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>

<span class="cm">/* Variables corresponding to PubSub connection creation,</span>
<span class="cm"> * published data set and writer group */</span><span class="w"></span>
<span class="n">UA_NodeId</span><span class="w">           </span><span class="n">connectionIdent</span><span class="p">;</span><span class="w"></span>
<span class="n">UA_NodeId</span><span class="w">           </span><span class="n">publishedDataSetIdent</span><span class="p">;</span><span class="w"></span>
<span class="n">UA_NodeId</span><span class="w">           </span><span class="n">writerGroupIdent</span><span class="p">;</span><span class="w"></span>
<span class="n">UA_NodeId</span><span class="w">           </span><span class="n">pubNodeID</span><span class="p">;</span><span class="w"></span>
<span class="n">UA_NodeId</span><span class="w">           </span><span class="n">subNodeID</span><span class="p">;</span><span class="w"></span>
<span class="n">UA_NodeId</span><span class="w">           </span><span class="n">pubRepeatedCountNodeID</span><span class="p">;</span><span class="w"></span>
<span class="n">UA_NodeId</span><span class="w">           </span><span class="n">subRepeatedCountNodeID</span><span class="p">;</span><span class="w"></span>
<span class="n">UA_NodeId</span><span class="w">           </span><span class="n">runningPubStatusNodeID</span><span class="p">;</span><span class="w"></span>
<span class="n">UA_NodeId</span><span class="w">           </span><span class="n">runningSubStatusNodeID</span><span class="p">;</span><span class="w"></span>
<span class="cm">/* Variables for counter data handling in address space */</span><span class="w"></span>
<span class="n">UA_UInt64</span><span class="w">           </span><span class="o">*</span><span class="n">pubCounterData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w"></span>
<span class="n">UA_DataValue</span><span class="w">        </span><span class="o">*</span><span class="n">pubDataValueRT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w"></span>
<span class="n">UA_Boolean</span><span class="w">          </span><span class="o">*</span><span class="n">runningPub</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w"></span>
<span class="n">UA_DataValue</span><span class="w">        </span><span class="o">*</span><span class="n">runningPubDataValueRT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w"></span>
<span class="n">UA_UInt64</span><span class="w">           </span><span class="o">*</span><span class="n">repeatedCounterData</span><span class="p">[</span><span class="n">REPEATED_NODECOUNTS</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="nb">NULL</span><span class="p">};</span><span class="w"></span>
<span class="n">UA_DataValue</span><span class="w">        </span><span class="o">*</span><span class="n">repeatedDataValueRT</span><span class="p">[</span><span class="n">REPEATED_NODECOUNTS</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="nb">NULL</span><span class="p">};</span><span class="w"></span>

<span class="n">UA_UInt64</span><span class="w">           </span><span class="o">*</span><span class="n">subCounterData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w"></span>
<span class="n">UA_DataValue</span><span class="w">        </span><span class="o">*</span><span class="n">subDataValueRT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w"></span>
<span class="n">UA_Boolean</span><span class="w">          </span><span class="o">*</span><span class="n">runningSub</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w"></span>
<span class="n">UA_DataValue</span><span class="w">        </span><span class="o">*</span><span class="n">runningSubDataValueRT</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="nb">NULL</span><span class="p">;</span><span class="w"></span>
<span class="n">UA_UInt64</span><span class="w">           </span><span class="o">*</span><span class="n">subRepeatedCounterData</span><span class="p">[</span><span class="n">REPEATED_NODECOUNTS</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="nb">NULL</span><span class="p">};</span><span class="w"></span>
<span class="n">UA_DataValue</span><span class="w">        </span><span class="o">*</span><span class="n">subRepeatedDataValueRT</span><span class="p">[</span><span class="n">REPEATED_NODECOUNTS</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="nb">NULL</span><span class="p">};</span><span class="w"></span>
</pre></div>
</div>
<section id="csv-file-handling">
<h2>CSV file handling<a class="headerlink" href="#csv-file-handling" title="Permalink to this heading">¶</a></h2>
<p>CSV files are written for Publisher and Subscriber thread. csv files include
the counterdata that is being either Published or Subscribed along with the
timestamp. These csv files can be used to compute latency for following
combinations of Tracepoints, T1-T4 and T1-T8.</p>
<p>T1-T8 - Gives the Round-trip time of a counterdata, as the value published by
the Publisher thread in pubsub_TSN_publisher.c example is subscribed by the
Subscriber thread in pubsub_TSN_loopback.c example and is published back to
the pubsub_TSN_publisher.c example</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#if defined(PUBLISHER)</span>
<span class="cm">/* File to store the data and timestamps for different traffic */</span><span class="w"></span>
<span class="kt">FILE</span><span class="w">               </span><span class="o">*</span><span class="n">fpPublisher</span><span class="p">;</span><span class="w"></span>
<span class="kt">char</span><span class="w">               </span><span class="o">*</span><span class="n">filePublishedData</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;publisher_T1.csv&quot;</span><span class="p">;</span><span class="w"></span>
<span class="cm">/* Array to store published counter data */</span><span class="w"></span>
<span class="n">UA_UInt64</span><span class="w">           </span><span class="n">publishCounterValue</span><span class="p">[</span><span class="n">MAX_MEASUREMENTS</span><span class="p">];</span><span class="w"></span>
<span class="kt">size_t</span><span class="w">              </span><span class="n">measurementsPublisher</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="cm">/* Array to store timestamp */</span><span class="w"></span>
<span class="k">struct</span><span class="w"> </span><span class="nc">timespec</span><span class="w">     </span><span class="n">publishTimestamp</span><span class="p">[</span><span class="n">MAX_MEASUREMENTS</span><span class="p">];</span><span class="w"></span>
<span class="cm">/* Thread for publisher */</span><span class="w"></span>
<span class="n">pthread_t</span><span class="w">           </span><span class="n">pubthreadID</span><span class="p">;</span><span class="w"></span>
<span class="k">struct</span><span class="w"> </span><span class="nc">timespec</span><span class="w">     </span><span class="n">dataModificationTime</span><span class="p">;</span><span class="w"></span>
<span class="cp">#endif</span>

<span class="cp">#if defined(SUBSCRIBER)</span>
<span class="cm">/* File to store the data and timestamps for different traffic */</span><span class="w"></span>
<span class="kt">FILE</span><span class="w">               </span><span class="o">*</span><span class="n">fpSubscriber</span><span class="p">;</span><span class="w"></span>
<span class="kt">char</span><span class="w">               </span><span class="o">*</span><span class="n">fileSubscribedData</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;subscriber_T8.csv&quot;</span><span class="p">;</span><span class="w"></span>
<span class="cm">/* Array to store subscribed counter data */</span><span class="w"></span>
<span class="n">UA_UInt64</span><span class="w">           </span><span class="n">subscribeCounterValue</span><span class="p">[</span><span class="n">MAX_MEASUREMENTS</span><span class="p">];</span><span class="w"></span>
<span class="kt">size_t</span><span class="w">              </span><span class="n">measurementsSubscriber</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="cm">/* Array to store timestamp */</span><span class="w"></span>
<span class="k">struct</span><span class="w"> </span><span class="nc">timespec</span><span class="w">     </span><span class="n">subscribeTimestamp</span><span class="p">[</span><span class="n">MAX_MEASUREMENTS</span><span class="p">];</span><span class="w"></span>
<span class="cm">/* Thread for subscriber */</span><span class="w"></span>
<span class="n">pthread_t</span><span class="w">           </span><span class="n">subthreadID</span><span class="p">;</span><span class="w"></span>
<span class="cm">/* Variable for PubSub connection creation */</span><span class="w"></span>
<span class="n">UA_NodeId</span><span class="w">           </span><span class="n">connectionIdentSubscriber</span><span class="p">;</span><span class="w"></span>
<span class="k">struct</span><span class="w"> </span><span class="nc">timespec</span><span class="w">     </span><span class="n">dataReceiveTime</span><span class="p">;</span><span class="w"></span>
<span class="cp">#endif</span>

<span class="cm">/* Thread for user application*/</span><span class="w"></span>
<span class="n">pthread_t</span><span class="w">           </span><span class="n">userApplicationThreadID</span><span class="p">;</span><span class="w"></span>

<span class="cm">/* Base time handling for the threads */</span><span class="w"></span>
<span class="k">struct</span><span class="w"> </span><span class="nc">timespec</span><span class="w">     </span><span class="n">threadBaseTime</span><span class="p">;</span><span class="w"></span>
<span class="n">UA_Boolean</span><span class="w">          </span><span class="n">baseTimeCalculated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>

<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="n">UA_Server</span><span class="o">*</span><span class="w">                   </span><span class="n">ServerRun</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"> </span><span class="n">serverConfigStruct</span><span class="p">;</span><span class="w"></span>

<span class="cm">/* Structure to define thread parameters */</span><span class="w"></span>
<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="n">UA_Server</span><span class="o">*</span><span class="w">                   </span><span class="n">server</span><span class="p">;</span><span class="w"></span>
<span class="kt">void</span><span class="o">*</span><span class="w">                        </span><span class="n">data</span><span class="p">;</span><span class="w"></span>
<span class="n">UA_ServerCallback</span><span class="w">            </span><span class="n">callback</span><span class="p">;</span><span class="w"></span>
<span class="n">UA_Duration</span><span class="w">                  </span><span class="n">interval_ms</span><span class="p">;</span><span class="w"></span>
<span class="n">UA_UInt64</span><span class="o">*</span><span class="w">                   </span><span class="n">callbackId</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"> </span><span class="n">threadArg</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>Function calls for different threads</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/* Publisher thread routine for ETF */</span><span class="w"></span>
<span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="nf">publisherETF</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">arg</span><span class="p">);</span><span class="w"></span>
<span class="cm">/* Subscriber thread routine */</span><span class="w"></span>
<span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="nf">subscriber</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">arg</span><span class="p">);</span><span class="w"></span>
<span class="cm">/* User application thread routine */</span><span class="w"></span>
<span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="nf">userApplicationPubSub</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">arg</span><span class="p">);</span><span class="w"></span>
<span class="cm">/* For adding nodes in the server information model */</span><span class="w"></span>
<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">addServerNodes</span><span class="p">(</span><span class="n">UA_Server</span><span class="w"> </span><span class="o">*</span><span class="n">server</span><span class="p">);</span><span class="w"></span>
<span class="cm">/* For deleting the nodes created */</span><span class="w"></span>
<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">removeServerNodes</span><span class="p">(</span><span class="n">UA_Server</span><span class="w"> </span><span class="o">*</span><span class="n">server</span><span class="p">);</span><span class="w"></span>
<span class="cm">/* To create multi-threads */</span><span class="w"></span>
<span class="k">static</span><span class="w"> </span><span class="n">pthread_t</span><span class="w"> </span><span class="nf">threadCreation</span><span class="p">(</span><span class="n">UA_Int16</span><span class="w"> </span><span class="n">threadPriority</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">coreAffinity</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="kr">thread</span><span class="p">)(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">),</span><span class="w"></span>
<span class="w">                                </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">applicationName</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">serverConfig</span><span class="p">);</span><span class="w"></span>

<span class="cm">/* Stop signal */</span><span class="w"></span>
<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">stopHandler</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">sign</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_LOG_INFO</span><span class="p">(</span><span class="n">UA_Log_Stdout</span><span class="p">,</span><span class="w"> </span><span class="n">UA_LOGCATEGORY_SERVER</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;received ctrl-c&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">signalTerm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p><strong>Nanosecond field handling</strong></p>
<p>Nanosecond field in timespec is checked for overflowing and one second
is added to seconds field and nanosecond field is set to zero</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="k">while</span><span class="p">(</span><span class="n">timeSpecValue</span><span class="o">-&gt;</span><span class="n">tv_nsec</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">SECONDS</span><span class="w"> </span><span class="mi">-1</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="cm">/* Move to next second and remove it from ns field */</span><span class="w"></span>
<span class="w">        </span><span class="n">timeSpecValue</span><span class="o">-&gt;</span><span class="n">tv_sec</span><span class="w">  </span><span class="o">+=</span><span class="w"> </span><span class="n">SECONDS_INCREMENT</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">timeSpecValue</span><span class="o">-&gt;</span><span class="n">tv_nsec</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">SECONDS</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p><strong>Custom callback handling</strong></p>
<p>Custom callback thread handling overwrites the default timer based
callback function with the custom (user-specified) callback interval.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/* Add a callback for cyclic repetition */</span><span class="w"></span>
<span class="k">static</span><span class="w"> </span><span class="n">UA_StatusCode</span><span class="w"></span>
<span class="nf">addPubSubApplicationCallback</span><span class="p">(</span><span class="n">UA_Server</span><span class="w"> </span><span class="o">*</span><span class="n">server</span><span class="p">,</span><span class="w"> </span><span class="n">UA_NodeId</span><span class="w"> </span><span class="n">identifier</span><span class="p">,</span><span class="w"></span>
<span class="w">                             </span><span class="n">UA_ServerCallback</span><span class="w"> </span><span class="n">callback</span><span class="p">,</span><span class="w"></span>
<span class="w">                             </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">UA_Double</span><span class="w"> </span><span class="n">interval_ms</span><span class="p">,</span><span class="w"></span>
<span class="w">                             </span><span class="n">UA_DateTime</span><span class="w"> </span><span class="o">*</span><span class="n">baseTime</span><span class="p">,</span><span class="w"> </span><span class="n">UA_TimerPolicy</span><span class="w"> </span><span class="n">timerPolicy</span><span class="p">,</span><span class="w"></span>
<span class="w">                             </span><span class="n">UA_UInt64</span><span class="w"> </span><span class="o">*</span><span class="n">callbackId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="cm">/* Initialize arguments required for the thread to run */</span><span class="w"></span>
<span class="w">    </span><span class="n">threadArg</span><span class="w"> </span><span class="o">*</span><span class="n">threadArguments</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">threadArg</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">UA_malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">threadArg</span><span class="p">));</span><span class="w"></span>

<span class="w">    </span><span class="cm">/* Pass the value required for the threads */</span><span class="w"></span>
<span class="w">    </span><span class="n">threadArguments</span><span class="o">-&gt;</span><span class="n">server</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="n">server</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">threadArguments</span><span class="o">-&gt;</span><span class="n">data</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">threadArguments</span><span class="o">-&gt;</span><span class="n">callback</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">callback</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">threadArguments</span><span class="o">-&gt;</span><span class="n">interval_ms</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">interval_ms</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">threadArguments</span><span class="o">-&gt;</span><span class="n">callbackId</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">callbackId</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="cm">/* Check the writer group identifier and create the thread accordingly */</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">UA_NodeId_equal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">identifier</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">writerGroupIdent</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="cp">#if defined(PUBLISHER)</span>
<span class="w">        </span><span class="cm">/* Create the publisher thread with the required priority and core affinity */</span><span class="w"></span>
<span class="w">        </span><span class="kt">char</span><span class="w"> </span><span class="n">threadNamePub</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Publisher&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="o">*</span><span class="n">callbackId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">threadCreation</span><span class="p">((</span><span class="n">UA_Int16</span><span class="p">)</span><span class="n">pubPriority</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="p">)</span><span class="n">pubCore</span><span class="p">,</span><span class="w"></span>
<span class="w">                                     </span><span class="n">publisherETF</span><span class="p">,</span><span class="w"> </span><span class="n">threadNamePub</span><span class="p">,</span><span class="w"> </span><span class="n">threadArguments</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">UA_LOG_INFO</span><span class="p">(</span><span class="n">UA_Log_Stdout</span><span class="p">,</span><span class="w"> </span><span class="n">UA_LOGCATEGORY_USERLAND</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="s">&quot;Publisher thread callback Id: %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="o">*</span><span class="n">callbackId</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="cp">#if defined(SUBSCRIBER)</span>
<span class="w">        </span><span class="cm">/* Create the subscriber thread with the required priority and core affinity */</span><span class="w"></span>
<span class="w">        </span><span class="kt">char</span><span class="w"> </span><span class="n">threadNameSub</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Subscriber&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="o">*</span><span class="n">callbackId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">threadCreation</span><span class="p">((</span><span class="n">UA_Int16</span><span class="p">)</span><span class="n">subPriority</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="p">)</span><span class="n">subCore</span><span class="p">,</span><span class="w"></span>
<span class="w">                                     </span><span class="n">subscriber</span><span class="p">,</span><span class="w"> </span><span class="n">threadNameSub</span><span class="p">,</span><span class="w"> </span><span class="n">threadArguments</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">UA_LOG_INFO</span><span class="p">(</span><span class="n">UA_Log_Stdout</span><span class="p">,</span><span class="w"> </span><span class="n">UA_LOGCATEGORY_USERLAND</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="s">&quot;Subscriber thread callback Id: %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="o">*</span><span class="n">callbackId</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">UA_STATUSCODE_GOOD</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">static</span><span class="w"> </span><span class="n">UA_StatusCode</span><span class="w"></span>
<span class="nf">changePubSubApplicationCallback</span><span class="p">(</span><span class="n">UA_Server</span><span class="w"> </span><span class="o">*</span><span class="n">server</span><span class="p">,</span><span class="w"> </span><span class="n">UA_NodeId</span><span class="w"> </span><span class="n">identifier</span><span class="p">,</span><span class="w"></span>
<span class="w">                                </span><span class="n">UA_UInt64</span><span class="w"> </span><span class="n">callbackId</span><span class="p">,</span><span class="w"> </span><span class="n">UA_Double</span><span class="w"> </span><span class="n">interval_ms</span><span class="p">,</span><span class="w"></span>
<span class="w">                                </span><span class="n">UA_DateTime</span><span class="w"> </span><span class="o">*</span><span class="n">baseTime</span><span class="p">,</span><span class="w"> </span><span class="n">UA_TimerPolicy</span><span class="w"> </span><span class="n">timerPolicy</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="cm">/* Callback interval need not be modified as it is thread based implementation.</span>
<span class="cm">     * The thread uses nanosleep for calculating cycle time and modification in</span>
<span class="cm">     * nanosleep value changes cycle time */</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">UA_STATUSCODE_GOOD</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="cm">/* Remove the callback added for cyclic repetition */</span><span class="w"></span>
<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"></span>
<span class="nf">removePubSubApplicationCallback</span><span class="p">(</span><span class="n">UA_Server</span><span class="w"> </span><span class="o">*</span><span class="n">server</span><span class="p">,</span><span class="w"> </span><span class="n">UA_NodeId</span><span class="w"> </span><span class="n">identifier</span><span class="p">,</span><span class="w"></span>
<span class="w">                                </span><span class="n">UA_UInt64</span><span class="w"> </span><span class="n">callbackId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">callbackId</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">pthread_join</span><span class="p">((</span><span class="n">pthread_t</span><span class="p">)</span><span class="n">callbackId</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="n">UA_LOG_WARNING</span><span class="p">(</span><span class="n">UA_Log_Stdout</span><span class="p">,</span><span class="w"> </span><span class="n">UA_LOGCATEGORY_USERLAND</span><span class="p">,</span><span class="w"></span>
<span class="w">                       </span><span class="s">&quot;Pthread Join Failed thread: %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="n">callbackId</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="external-data-source-handling">
<h2>External data source handling<a class="headerlink" href="#external-data-source-handling" title="Permalink to this heading">¶</a></h2>
<p>If the external data source is written over the information model, the
externalDataWriteCallback will be triggered. The user has to take care and
assure that the write leads not to synchronization issues and race
conditions.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="n">UA_StatusCode</span><span class="w"></span>
<span class="nf">externalDataWriteCallback</span><span class="p">(</span><span class="n">UA_Server</span><span class="w"> </span><span class="o">*</span><span class="n">server</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">UA_NodeId</span><span class="w"> </span><span class="o">*</span><span class="n">sessionId</span><span class="p">,</span><span class="w"></span>
<span class="w">                          </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">sessionContext</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">UA_NodeId</span><span class="w"> </span><span class="o">*</span><span class="n">nodeId</span><span class="p">,</span><span class="w"></span>
<span class="w">                          </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">nodeContext</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">UA_NumericRange</span><span class="w"> </span><span class="o">*</span><span class="n">range</span><span class="p">,</span><span class="w"></span>
<span class="w">                          </span><span class="k">const</span><span class="w"> </span><span class="n">UA_DataValue</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="c1">//node values are updated by using variables in the memory</span>
<span class="w">    </span><span class="c1">//UA_Server_write is not used for updating node values.</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">UA_STATUSCODE_GOOD</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">static</span><span class="w"> </span><span class="n">UA_StatusCode</span><span class="w"></span>
<span class="nf">externalDataReadNotificationCallback</span><span class="p">(</span><span class="n">UA_Server</span><span class="w"> </span><span class="o">*</span><span class="n">server</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">UA_NodeId</span><span class="w"> </span><span class="o">*</span><span class="n">sessionId</span><span class="p">,</span><span class="w"></span>
<span class="w">                                     </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">sessionContext</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">UA_NodeId</span><span class="w"> </span><span class="o">*</span><span class="n">nodeid</span><span class="p">,</span><span class="w"></span>
<span class="w">                                     </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">nodeContext</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">UA_NumericRange</span><span class="w"> </span><span class="o">*</span><span class="n">range</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="c1">//allow read without any preparation</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">UA_STATUSCODE_GOOD</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="subscriber">
<h2>Subscriber<a class="headerlink" href="#subscriber" title="Permalink to this heading">¶</a></h2>
<p>Create connection, readergroup, datasetreader, subscribedvariables for the
Subscriber thread.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#if defined(SUBSCRIBER)</span>
<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"></span>
<span class="nf">addPubSubConnectionSubscriber</span><span class="p">(</span><span class="n">UA_Server</span><span class="w"> </span><span class="o">*</span><span class="n">server</span><span class="p">,</span><span class="w"></span>
<span class="w">                              </span><span class="n">UA_NetworkAddressUrlDataType</span><span class="w"> </span><span class="o">*</span><span class="n">networkAddressUrlSubscriber</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_StatusCode</span><span class="w">    </span><span class="n">retval</span><span class="w">                                 </span><span class="o">=</span><span class="w"> </span><span class="n">UA_STATUSCODE_GOOD</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="cm">/* Details about the connection configuration and handling are located</span>
<span class="cm">     * in the pubsub connection tutorial */</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_PubSubConnectionConfig</span><span class="w"> </span><span class="n">connectionConfig</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">connectionConfig</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">connectionConfig</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="n">connectionConfig</span><span class="p">.</span><span class="n">name</span><span class="w">                                   </span><span class="o">=</span><span class="w"> </span><span class="n">UA_STRING</span><span class="p">(</span><span class="s">&quot;Subscriber Connection&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">connectionConfig</span><span class="p">.</span><span class="n">enabled</span><span class="w">                                </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">UA_KeyValuePair</span><span class="w"> </span><span class="n">connectionOptions</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="n">connectionOptions</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">key</span><span class="w">                  </span><span class="o">=</span><span class="w"> </span><span class="n">UA_QUALIFIEDNAME</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;enableXdpSocket&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_Boolean</span><span class="w"> </span><span class="n">enableXdp</span><span class="w">                      </span><span class="o">=</span><span class="w"> </span><span class="n">enableXdpSubscribe</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_Variant_setScalar</span><span class="p">(</span><span class="o">&amp;</span><span class="n">connectionOptions</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">enableXdp</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">UA_TYPES</span><span class="p">[</span><span class="n">UA_TYPES_BOOLEAN</span><span class="p">]);</span><span class="w"></span>
<span class="w">    </span><span class="n">connectionOptions</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">key</span><span class="w">                  </span><span class="o">=</span><span class="w"> </span><span class="n">UA_QUALIFIEDNAME</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;xdpflag&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_UInt32</span><span class="w"> </span><span class="n">flags</span><span class="w">                           </span><span class="o">=</span><span class="w"> </span><span class="n">xdpFlag</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_Variant_setScalar</span><span class="p">(</span><span class="o">&amp;</span><span class="n">connectionOptions</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">flags</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">UA_TYPES</span><span class="p">[</span><span class="n">UA_TYPES_UINT32</span><span class="p">]);</span><span class="w"></span>
<span class="w">    </span><span class="n">connectionOptions</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">key</span><span class="w">                  </span><span class="o">=</span><span class="w"> </span><span class="n">UA_QUALIFIEDNAME</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;hwreceivequeue&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_UInt32</span><span class="w"> </span><span class="n">rxqueue</span><span class="w">                         </span><span class="o">=</span><span class="w"> </span><span class="n">xdpQueue</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_Variant_setScalar</span><span class="p">(</span><span class="o">&amp;</span><span class="n">connectionOptions</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">rxqueue</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">UA_TYPES</span><span class="p">[</span><span class="n">UA_TYPES_UINT32</span><span class="p">]);</span><span class="w"></span>
<span class="w">    </span><span class="n">connectionOptions</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">key</span><span class="w">                  </span><span class="o">=</span><span class="w"> </span><span class="n">UA_QUALIFIEDNAME</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;xdpbindflag&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_UInt32</span><span class="w"> </span><span class="n">bindflags</span><span class="w">                       </span><span class="o">=</span><span class="w"> </span><span class="n">xdpBindFlag</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_Variant_setScalar</span><span class="p">(</span><span class="o">&amp;</span><span class="n">connectionOptions</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">bindflags</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">UA_TYPES</span><span class="p">[</span><span class="n">UA_TYPES_UINT16</span><span class="p">]);</span><span class="w"></span>
<span class="w">    </span><span class="n">connectionConfig</span><span class="p">.</span><span class="n">connectionProperties</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="n">connectionOptions</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">connectionConfig</span><span class="p">.</span><span class="n">connectionPropertiesSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span><span class="w"></span>


<span class="w">    </span><span class="n">UA_NetworkAddressUrlDataType</span><span class="w"> </span><span class="n">networkAddressUrlsubscribe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">networkAddressUrlSubscriber</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">connectionConfig</span><span class="p">.</span><span class="n">transportProfileUri</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UA_STRING</span><span class="p">(</span><span class="n">ETH_TRANSPORT_PROFILE</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_Variant_setScalar</span><span class="p">(</span><span class="o">&amp;</span><span class="n">connectionConfig</span><span class="p">.</span><span class="n">address</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">networkAddressUrlsubscribe</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">UA_TYPES</span><span class="p">[</span><span class="n">UA_TYPES_NETWORKADDRESSURLDATATYPE</span><span class="p">]);</span><span class="w"></span>
<span class="w">    </span><span class="n">connectionConfig</span><span class="p">.</span><span class="n">publisherId</span><span class="p">.</span><span class="n">numeric</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UA_UInt32_random</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">retval</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">UA_Server_addPubSubConnection</span><span class="p">(</span><span class="n">server</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">connectionConfig</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">connectionIdentSubscriber</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">retval</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">UA_STATUSCODE_GOOD</span><span class="p">)</span><span class="w"></span>
<span class="w">         </span><span class="n">UA_LOG_INFO</span><span class="p">(</span><span class="n">UA_Log_Stdout</span><span class="p">,</span><span class="w"> </span><span class="n">UA_LOGCATEGORY_SERVER</span><span class="p">,</span><span class="w"></span>
<span class="w">                     </span><span class="s">&quot;The PubSub Connection was created successfully!&quot;</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="cm">/* Add ReaderGroup to the created connection */</span><span class="w"></span>
<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"></span>
<span class="nf">addReaderGroup</span><span class="p">(</span><span class="n">UA_Server</span><span class="w"> </span><span class="o">*</span><span class="n">server</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">server</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">UA_ReaderGroupConfig</span><span class="w"> </span><span class="n">readerGroupConfig</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">readerGroupConfig</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">UA_ReaderGroupConfig</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="n">readerGroupConfig</span><span class="p">.</span><span class="n">name</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">UA_STRING</span><span class="p">(</span><span class="s">&quot;ReaderGroup1&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">readerGroupConfig</span><span class="p">.</span><span class="n">rtLevel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UA_PUBSUB_RT_FIXED_SIZE</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">readerGroupConfig</span><span class="p">.</span><span class="n">subscribingInterval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cycleTimeInMsec</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="cm">/* Timeout is modified when blocking socket is enabled, and the default</span>
<span class="cm">     * timeout is used when blocking socket is disabled */</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">enableBlockingSocket</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">false</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">readerGroupConfig</span><span class="p">.</span><span class="n">timeout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">50</span><span class="p">;</span><span class="w">  </span><span class="c1">// As we run in 250us cycle time, modify default timeout (1ms) to 50us</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">readerGroupConfig</span><span class="p">.</span><span class="n">enableBlockingSocket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">readerGroupConfig</span><span class="p">.</span><span class="n">timeout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">  </span><span class="c1">//Blocking  socket</span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="cp">#ifdef UA_ENABLE_PUBSUB_ENCRYPTION</span>
<span class="w">    </span><span class="cm">/* Encryption settings */</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_ServerConfig</span><span class="w"> </span><span class="o">*</span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UA_Server_getConfig</span><span class="p">(</span><span class="n">server</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">readerGroupConfig</span><span class="p">.</span><span class="n">securityMode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UA_MESSAGESECURITYMODE_SIGNANDENCRYPT</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">readerGroupConfig</span><span class="p">.</span><span class="n">securityPolicy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">pubSubConfig</span><span class="p">.</span><span class="n">securityPolicies</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span><span class="w"></span>
<span class="cp">#endif</span>

<span class="w">    </span><span class="n">readerGroupConfig</span><span class="p">.</span><span class="n">pubsubManagerCallback</span><span class="p">.</span><span class="n">addCustomCallback</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">addPubSubApplicationCallback</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">readerGroupConfig</span><span class="p">.</span><span class="n">pubsubManagerCallback</span><span class="p">.</span><span class="n">changeCustomCallback</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">changePubSubApplicationCallback</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">readerGroupConfig</span><span class="p">.</span><span class="n">pubsubManagerCallback</span><span class="p">.</span><span class="n">removeCustomCallback</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">removePubSubApplicationCallback</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">UA_Server_addReaderGroup</span><span class="p">(</span><span class="n">server</span><span class="p">,</span><span class="w"> </span><span class="n">connectionIdentSubscriber</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">readerGroupConfig</span><span class="p">,</span><span class="w"></span>
<span class="w">                             </span><span class="o">&amp;</span><span class="n">readerGroupIdentifier</span><span class="p">);</span><span class="w"></span>

<span class="cp">#ifdef UA_ENABLE_PUBSUB_ENCRYPTION</span>
<span class="w">    </span><span class="cm">/* Add the encryption key informaton */</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_ByteString</span><span class="w"> </span><span class="n">sk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">UA_AES128CTR_SIGNING_KEY_LENGTH</span><span class="p">,</span><span class="w"> </span><span class="n">signingKeySub</span><span class="p">};</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_ByteString</span><span class="w"> </span><span class="n">ek</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">UA_AES128CTR_KEY_LENGTH</span><span class="p">,</span><span class="w"> </span><span class="n">encryptingKeySub</span><span class="p">};</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_ByteString</span><span class="w"> </span><span class="n">kn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">UA_AES128CTR_KEYNONCE_LENGTH</span><span class="p">,</span><span class="w"> </span><span class="n">keyNonceSub</span><span class="p">};</span><span class="w"></span>
<span class="w">    </span><span class="c1">// TODO security token not necessary for readergroup (extracted from security-header)</span>
<span class="w">    </span><span class="n">UA_Server_setReaderGroupEncryptionKeys</span><span class="p">(</span><span class="n">server</span><span class="p">,</span><span class="w"> </span><span class="n">readerGroupIdentifier</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">sk</span><span class="p">,</span><span class="w"> </span><span class="n">ek</span><span class="p">,</span><span class="w"> </span><span class="n">kn</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="p">}</span><span class="w"></span>


<span class="cm">/* Set SubscribedDataSet type to TargetVariables data type</span>
<span class="cm"> * Add SubscriberCounter variable to the DataSetReader */</span><span class="w"></span>
<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"></span>
<span class="nf">addSubscribedVariables</span><span class="p">(</span><span class="n">UA_Server</span><span class="w"> </span><span class="o">*</span><span class="n">server</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_Int32</span><span class="w"> </span><span class="n">iterator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_Int32</span><span class="w"> </span><span class="n">iteratorRepeatedCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">server</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">UA_FieldTargetVariable</span><span class="w"> </span><span class="o">*</span><span class="n">targetVars</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">UA_FieldTargetVariable</span><span class="o">*</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">UA_calloc</span><span class="p">((</span><span class="n">REPEATED_NODECOUNTS</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">),</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">UA_FieldTargetVariable</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">targetVars</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">UA_LOG_ERROR</span><span class="p">(</span><span class="n">UA_Log_Stdout</span><span class="p">,</span><span class="w"> </span><span class="n">UA_LOGCATEGORY_SERVER</span><span class="p">,</span><span class="w"></span>
<span class="w">                     </span><span class="s">&quot;FieldTargetVariable - Bad out of memory&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">runningSub</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UA_Boolean_new</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">runningSub</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">UA_LOG_ERROR</span><span class="p">(</span><span class="n">UA_Log_Stdout</span><span class="p">,</span><span class="w"> </span><span class="n">UA_LOGCATEGORY_SERVER</span><span class="p">,</span><span class="w"></span>
<span class="w">                     </span><span class="s">&quot;runningsub - Bad out of memory&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="o">*</span><span class="n">runningSub</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">runningSubDataValueRT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UA_DataValue_new</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">runningSubDataValueRT</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">UA_LOG_ERROR</span><span class="p">(</span><span class="n">UA_Log_Stdout</span><span class="p">,</span><span class="w"> </span><span class="n">UA_LOGCATEGORY_SERVER</span><span class="p">,</span><span class="w"></span>
<span class="w">                     </span><span class="s">&quot;runningsubDataValue - Bad out of memory&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">UA_Variant_setScalar</span><span class="p">(</span><span class="o">&amp;</span><span class="n">runningSubDataValueRT</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">runningSub</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">UA_TYPES</span><span class="p">[</span><span class="n">UA_TYPES_BOOLEAN</span><span class="p">]);</span><span class="w"></span>
<span class="w">    </span><span class="n">runningSubDataValueRT</span><span class="o">-&gt;</span><span class="n">hasValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="cm">/* Set the value backend of the above create node to &#39;external value source&#39; */</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_ValueBackend</span><span class="w"> </span><span class="n">runningSubvalueBackend</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">runningSubvalueBackend</span><span class="p">.</span><span class="n">backendType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UA_VALUEBACKENDTYPE_EXTERNAL</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">runningSubvalueBackend</span><span class="p">.</span><span class="n">backend</span><span class="p">.</span><span class="n">external</span><span class="p">.</span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">runningSubDataValueRT</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">runningSubvalueBackend</span><span class="p">.</span><span class="n">backend</span><span class="p">.</span><span class="n">external</span><span class="p">.</span><span class="n">callback</span><span class="p">.</span><span class="n">userWrite</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">externalDataWriteCallback</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">runningSubvalueBackend</span><span class="p">.</span><span class="n">backend</span><span class="p">.</span><span class="n">external</span><span class="p">.</span><span class="n">callback</span><span class="p">.</span><span class="n">notificationRead</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">externalDataReadNotificationCallback</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_Server_setVariableNode_valueBackend</span><span class="p">(</span><span class="n">server</span><span class="p">,</span><span class="w"> </span><span class="n">UA_NODEID_NUMERIC</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">UA_UInt32</span><span class="p">)</span><span class="mi">30000</span><span class="p">),</span><span class="w"> </span><span class="n">runningSubvalueBackend</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">UA_FieldTargetDataType_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">targetVars</span><span class="p">[</span><span class="n">iterator</span><span class="p">].</span><span class="n">targetVariable</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">targetVars</span><span class="p">[</span><span class="n">iterator</span><span class="p">].</span><span class="n">targetVariable</span><span class="p">.</span><span class="n">attributeId</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">UA_ATTRIBUTEID_VALUE</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">targetVars</span><span class="p">[</span><span class="n">iterator</span><span class="p">].</span><span class="n">targetVariable</span><span class="p">.</span><span class="n">targetNodeId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UA_NODEID_NUMERIC</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">UA_UInt32</span><span class="p">)</span><span class="mi">30000</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">iterator</span><span class="o">++</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="cm">/* For creating Targetvariable */</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="n">iterator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">iteratorRepeatedCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">iterator</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">REPEATED_NODECOUNTS</span><span class="p">;</span><span class="w"> </span><span class="n">iterator</span><span class="o">++</span><span class="p">,</span><span class="w"> </span><span class="n">iteratorRepeatedCount</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">subRepeatedCounterData</span><span class="p">[</span><span class="n">iteratorRepeatedCount</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UA_UInt64_new</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">subRepeatedCounterData</span><span class="p">[</span><span class="n">iteratorRepeatedCount</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">UA_LOG_ERROR</span><span class="p">(</span><span class="n">UA_Log_Stdout</span><span class="p">,</span><span class="w"> </span><span class="n">UA_LOGCATEGORY_SERVER</span><span class="p">,</span><span class="w"></span>
<span class="w">                         </span><span class="s">&quot;SubscribeRepeatedCounterData - Bad out of memory&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">       </span><span class="o">*</span><span class="n">subRepeatedCounterData</span><span class="p">[</span><span class="n">iteratorRepeatedCount</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">       </span><span class="n">subRepeatedDataValueRT</span><span class="p">[</span><span class="n">iteratorRepeatedCount</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UA_DataValue_new</span><span class="p">();</span><span class="w"></span>
<span class="w">       </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">subRepeatedDataValueRT</span><span class="p">[</span><span class="n">iteratorRepeatedCount</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">UA_LOG_ERROR</span><span class="p">(</span><span class="n">UA_Log_Stdout</span><span class="p">,</span><span class="w"> </span><span class="n">UA_LOGCATEGORY_SERVER</span><span class="p">,</span><span class="w"></span>
<span class="w">                         </span><span class="s">&quot;SubscribeRepeatedCounterDataValue - Bad out of memory&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="n">UA_Variant_setScalar</span><span class="p">(</span><span class="o">&amp;</span><span class="n">subRepeatedDataValueRT</span><span class="p">[</span><span class="n">iteratorRepeatedCount</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">,</span><span class="w"></span>
<span class="w">                             </span><span class="n">subRepeatedCounterData</span><span class="p">[</span><span class="n">iteratorRepeatedCount</span><span class="p">],</span><span class="w"> </span><span class="o">&amp;</span><span class="n">UA_TYPES</span><span class="p">[</span><span class="n">UA_TYPES_UINT64</span><span class="p">]);</span><span class="w"></span>
<span class="w">        </span><span class="n">subRepeatedDataValueRT</span><span class="p">[</span><span class="n">iteratorRepeatedCount</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">hasValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="cm">/* Set the value backend of the above create node to &#39;external value source&#39; */</span><span class="w"></span>
<span class="w">        </span><span class="n">UA_ValueBackend</span><span class="w"> </span><span class="n">valueBackend</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">valueBackend</span><span class="p">.</span><span class="n">backendType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UA_VALUEBACKENDTYPE_EXTERNAL</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">valueBackend</span><span class="p">.</span><span class="n">backend</span><span class="p">.</span><span class="n">external</span><span class="p">.</span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">subRepeatedDataValueRT</span><span class="p">[</span><span class="n">iteratorRepeatedCount</span><span class="p">];</span><span class="w"></span>
<span class="w">        </span><span class="n">valueBackend</span><span class="p">.</span><span class="n">backend</span><span class="p">.</span><span class="n">external</span><span class="p">.</span><span class="n">callback</span><span class="p">.</span><span class="n">userWrite</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">externalDataWriteCallback</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">valueBackend</span><span class="p">.</span><span class="n">backend</span><span class="p">.</span><span class="n">external</span><span class="p">.</span><span class="n">callback</span><span class="p">.</span><span class="n">notificationRead</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">externalDataReadNotificationCallback</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">UA_Server_setVariableNode_valueBackend</span><span class="p">(</span><span class="n">server</span><span class="p">,</span><span class="w"> </span><span class="n">UA_NODEID_NUMERIC</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">UA_UInt32</span><span class="p">)</span><span class="n">iteratorRepeatedCount</span><span class="o">+</span><span class="mi">50000</span><span class="p">),</span><span class="w"> </span><span class="n">valueBackend</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="n">UA_FieldTargetDataType_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">targetVars</span><span class="p">[</span><span class="n">iterator</span><span class="p">].</span><span class="n">targetVariable</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">targetVars</span><span class="p">[</span><span class="n">iterator</span><span class="p">].</span><span class="n">targetVariable</span><span class="p">.</span><span class="n">attributeId</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">UA_ATTRIBUTEID_VALUE</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">targetVars</span><span class="p">[</span><span class="n">iterator</span><span class="p">].</span><span class="n">targetVariable</span><span class="p">.</span><span class="n">targetNodeId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UA_NODEID_NUMERIC</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">UA_UInt32</span><span class="p">)</span><span class="n">iteratorRepeatedCount</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">50000</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">subCounterData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UA_UInt64_new</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">subCounterData</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">UA_LOG_ERROR</span><span class="p">(</span><span class="n">UA_Log_Stdout</span><span class="p">,</span><span class="w"> </span><span class="n">UA_LOGCATEGORY_SERVER</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;SubscribeCounterData - Bad out of memory&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="o">*</span><span class="n">subCounterData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">subDataValueRT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UA_DataValue_new</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">subDataValueRT</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">UA_LOG_ERROR</span><span class="p">(</span><span class="n">UA_Log_Stdout</span><span class="p">,</span><span class="w"> </span><span class="n">UA_LOGCATEGORY_SERVER</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;SubscribeDataValue - Bad out of memory&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">UA_Variant_setScalar</span><span class="p">(</span><span class="o">&amp;</span><span class="n">subDataValueRT</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">subCounterData</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">UA_TYPES</span><span class="p">[</span><span class="n">UA_TYPES_UINT64</span><span class="p">]);</span><span class="w"></span>
<span class="w">    </span><span class="n">subDataValueRT</span><span class="o">-&gt;</span><span class="n">hasValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="cm">/* Set the value backend of the above create node to &#39;external value source&#39; */</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_ValueBackend</span><span class="w"> </span><span class="n">valueBackend</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">valueBackend</span><span class="p">.</span><span class="n">backendType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UA_VALUEBACKENDTYPE_EXTERNAL</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">valueBackend</span><span class="p">.</span><span class="n">backend</span><span class="p">.</span><span class="n">external</span><span class="p">.</span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">subDataValueRT</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">valueBackend</span><span class="p">.</span><span class="n">backend</span><span class="p">.</span><span class="n">external</span><span class="p">.</span><span class="n">callback</span><span class="p">.</span><span class="n">userWrite</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">externalDataWriteCallback</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">valueBackend</span><span class="p">.</span><span class="n">backend</span><span class="p">.</span><span class="n">external</span><span class="p">.</span><span class="n">callback</span><span class="p">.</span><span class="n">notificationRead</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">externalDataReadNotificationCallback</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_Server_setVariableNode_valueBackend</span><span class="p">(</span><span class="n">server</span><span class="p">,</span><span class="w"> </span><span class="n">subNodeID</span><span class="p">,</span><span class="w"> </span><span class="n">valueBackend</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">UA_FieldTargetDataType_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">targetVars</span><span class="p">[</span><span class="n">iterator</span><span class="p">].</span><span class="n">targetVariable</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">targetVars</span><span class="p">[</span><span class="n">iterator</span><span class="p">].</span><span class="n">targetVariable</span><span class="p">.</span><span class="n">attributeId</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">UA_ATTRIBUTEID_VALUE</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">targetVars</span><span class="p">[</span><span class="n">iterator</span><span class="p">].</span><span class="n">targetVariable</span><span class="p">.</span><span class="n">targetNodeId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">subNodeID</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="cm">/* Set the subscribed data to TargetVariable type */</span><span class="w"></span>
<span class="w">    </span><span class="n">readerConfig</span><span class="p">.</span><span class="n">subscribedDataSetType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UA_PUBSUB_SDS_TARGET</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">readerConfig</span><span class="p">.</span><span class="n">subscribedDataSet</span><span class="p">.</span><span class="n">subscribedDataSetTarget</span><span class="p">.</span><span class="n">targetVariables</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">targetVars</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">readerConfig</span><span class="p">.</span><span class="n">subscribedDataSet</span><span class="p">.</span><span class="n">subscribedDataSetTarget</span><span class="p">.</span><span class="n">targetVariablesSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">REPEATED_NODECOUNTS</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="cm">/* Add DataSetReader to the ReaderGroup */</span><span class="w"></span>
<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"></span>
<span class="nf">addDataSetReader</span><span class="p">(</span><span class="n">UA_Server</span><span class="w"> </span><span class="o">*</span><span class="n">server</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_Int32</span><span class="w"> </span><span class="n">iterator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">server</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">readerConfig</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">UA_DataSetReaderConfig</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="n">readerConfig</span><span class="p">.</span><span class="n">name</span><span class="w">                 </span><span class="o">=</span><span class="w"> </span><span class="n">UA_STRING</span><span class="p">(</span><span class="s">&quot;DataSet Reader 1&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_UInt16</span><span class="w"> </span><span class="n">publisherIdentifier</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="n">PUBLISHER_ID_SUB</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">readerConfig</span><span class="p">.</span><span class="n">publisherId</span><span class="p">.</span><span class="n">type</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">UA_TYPES</span><span class="p">[</span><span class="n">UA_TYPES_UINT16</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="n">readerConfig</span><span class="p">.</span><span class="n">publisherId</span><span class="p">.</span><span class="n">data</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">publisherIdentifier</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">readerConfig</span><span class="p">.</span><span class="n">writerGroupId</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="n">WRITER_GROUP_ID_SUB</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">readerConfig</span><span class="p">.</span><span class="n">dataSetWriterId</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="n">DATA_SET_WRITER_ID_SUB</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">readerConfig</span><span class="p">.</span><span class="n">messageSettings</span><span class="p">.</span><span class="n">encoding</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UA_EXTENSIONOBJECT_DECODED</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">readerConfig</span><span class="p">.</span><span class="n">messageSettings</span><span class="p">.</span><span class="n">content</span><span class="p">.</span><span class="n">decoded</span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">UA_TYPES</span><span class="p">[</span><span class="n">UA_TYPES_UADPDATASETREADERMESSAGEDATATYPE</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_UadpDataSetReaderMessageDataType</span><span class="w"> </span><span class="o">*</span><span class="n">dataSetReaderMessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UA_UadpDataSetReaderMessageDataType_new</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">dataSetReaderMessage</span><span class="o">-&gt;</span><span class="n">networkMessageContentMask</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="n">UA_UadpNetworkMessageContentMask</span><span class="p">)(</span><span class="n">UA_UADPNETWORKMESSAGECONTENTMASK_PUBLISHERID</span><span class="w"> </span><span class="o">|</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="n">UA_UadpNetworkMessageContentMask</span><span class="p">)</span><span class="n">UA_UADPNETWORKMESSAGECONTENTMASK_GROUPHEADER</span><span class="w"> </span><span class="o">|</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="n">UA_UadpNetworkMessageContentMask</span><span class="p">)</span><span class="n">UA_UADPNETWORKMESSAGECONTENTMASK_WRITERGROUPID</span><span class="w"> </span><span class="o">|</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="n">UA_UadpNetworkMessageContentMask</span><span class="p">)</span><span class="n">UA_UADPNETWORKMESSAGECONTENTMASK_PAYLOADHEADER</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">readerConfig</span><span class="p">.</span><span class="n">messageSettings</span><span class="p">.</span><span class="n">content</span><span class="p">.</span><span class="n">decoded</span><span class="p">.</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dataSetReaderMessage</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="cm">/* Setting up Meta data configuration in DataSetReader */</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_DataSetMetaDataType</span><span class="w"> </span><span class="o">*</span><span class="n">pMetaData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">readerConfig</span><span class="p">.</span><span class="n">dataSetMetaData</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="cm">/* FilltestMetadata function in subscriber implementation */</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_DataSetMetaDataType_init</span><span class="p">(</span><span class="n">pMetaData</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">pMetaData</span><span class="o">-&gt;</span><span class="n">name</span><span class="w">                   </span><span class="o">=</span><span class="w"> </span><span class="n">UA_STRING</span><span class="p">(</span><span class="s">&quot;DataSet Test&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="cm">/* Static definition of number of fields size to 1 to create one</span>
<span class="cm">       targetVariable */</span><span class="w"></span>
<span class="w">    </span><span class="n">pMetaData</span><span class="o">-&gt;</span><span class="n">fieldsSize</span><span class="w">             </span><span class="o">=</span><span class="w"> </span><span class="n">REPEATED_NODECOUNTS</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">pMetaData</span><span class="o">-&gt;</span><span class="n">fields</span><span class="w">                 </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">UA_FieldMetaData</span><span class="o">*</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">UA_Array_new</span><span class="p">(</span><span class="n">pMetaData</span><span class="o">-&gt;</span><span class="n">fieldsSize</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">UA_TYPES</span><span class="p">[</span><span class="n">UA_TYPES_FIELDMETADATA</span><span class="p">]);</span><span class="w"></span>

<span class="w">    </span><span class="cm">/* Boolean DataType */</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_FieldMetaData_init</span><span class="w"> </span><span class="p">(</span><span class="o">&amp;</span><span class="n">pMetaData</span><span class="o">-&gt;</span><span class="n">fields</span><span class="p">[</span><span class="n">iterator</span><span class="p">]);</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_NodeId_copy</span><span class="w"> </span><span class="p">(</span><span class="o">&amp;</span><span class="n">UA_TYPES</span><span class="p">[</span><span class="n">UA_TYPES_BOOLEAN</span><span class="p">].</span><span class="n">typeId</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="o">&amp;</span><span class="n">pMetaData</span><span class="o">-&gt;</span><span class="n">fields</span><span class="p">[</span><span class="n">iterator</span><span class="p">].</span><span class="n">dataType</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">pMetaData</span><span class="o">-&gt;</span><span class="n">fields</span><span class="p">[</span><span class="n">iterator</span><span class="p">].</span><span class="n">builtInType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UA_NS0ID_BOOLEAN</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">pMetaData</span><span class="o">-&gt;</span><span class="n">fields</span><span class="p">[</span><span class="n">iterator</span><span class="p">].</span><span class="n">valueRank</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span><span class="w"> </span><span class="cm">/* scalar */</span><span class="w"></span>
<span class="w">    </span><span class="n">iterator</span><span class="o">++</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="n">iterator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">iterator</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">REPEATED_NODECOUNTS</span><span class="p">;</span><span class="w"> </span><span class="n">iterator</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">UA_FieldMetaData_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pMetaData</span><span class="o">-&gt;</span><span class="n">fields</span><span class="p">[</span><span class="n">iterator</span><span class="p">]);</span><span class="w"></span>
<span class="w">        </span><span class="n">UA_NodeId_copy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">UA_TYPES</span><span class="p">[</span><span class="n">UA_TYPES_UINT64</span><span class="p">].</span><span class="n">typeId</span><span class="p">,</span><span class="w"></span>
<span class="w">                       </span><span class="o">&amp;</span><span class="n">pMetaData</span><span class="o">-&gt;</span><span class="n">fields</span><span class="p">[</span><span class="n">iterator</span><span class="p">].</span><span class="n">dataType</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">pMetaData</span><span class="o">-&gt;</span><span class="n">fields</span><span class="p">[</span><span class="n">iterator</span><span class="p">].</span><span class="n">builtInType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UA_NS0ID_UINT64</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">pMetaData</span><span class="o">-&gt;</span><span class="n">fields</span><span class="p">[</span><span class="n">iterator</span><span class="p">].</span><span class="n">valueRank</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span><span class="w"> </span><span class="cm">/* scalar */</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cm">/* Unsigned Integer DataType */</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_FieldMetaData_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pMetaData</span><span class="o">-&gt;</span><span class="n">fields</span><span class="p">[</span><span class="n">iterator</span><span class="p">]);</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_NodeId_copy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">UA_TYPES</span><span class="p">[</span><span class="n">UA_TYPES_UINT64</span><span class="p">].</span><span class="n">typeId</span><span class="p">,</span><span class="w"></span>
<span class="w">                   </span><span class="o">&amp;</span><span class="n">pMetaData</span><span class="o">-&gt;</span><span class="n">fields</span><span class="p">[</span><span class="n">iterator</span><span class="p">].</span><span class="n">dataType</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">pMetaData</span><span class="o">-&gt;</span><span class="n">fields</span><span class="p">[</span><span class="n">iterator</span><span class="p">].</span><span class="n">builtInType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UA_NS0ID_UINT64</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">pMetaData</span><span class="o">-&gt;</span><span class="n">fields</span><span class="p">[</span><span class="n">iterator</span><span class="p">].</span><span class="n">valueRank</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span><span class="w"> </span><span class="cm">/* scalar */</span><span class="w"></span>

<span class="w">    </span><span class="cm">/* Setup Target Variables in DSR config */</span><span class="w"></span>
<span class="w">    </span><span class="n">addSubscribedVariables</span><span class="p">(</span><span class="n">server</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="cm">/* Setting up Meta data configuration in DataSetReader */</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_Server_addDataSetReader</span><span class="p">(</span><span class="n">server</span><span class="p">,</span><span class="w"> </span><span class="n">readerGroupIdentifier</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">readerConfig</span><span class="p">,</span><span class="w"></span>
<span class="w">                               </span><span class="o">&amp;</span><span class="n">readerIdentifier</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">UA_free</span><span class="p">(</span><span class="n">readerConfig</span><span class="p">.</span><span class="n">subscribedDataSet</span><span class="p">.</span><span class="n">subscribedDataSetTarget</span><span class="p">.</span><span class="n">targetVariables</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_free</span><span class="p">(</span><span class="n">readerConfig</span><span class="p">.</span><span class="n">dataSetMetaData</span><span class="p">.</span><span class="n">fields</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_UadpDataSetReaderMessageDataType_delete</span><span class="p">(</span><span class="n">dataSetReaderMessage</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="cp">#endif</span>

<span class="cp">#if defined(PUBLISHER)</span>
</pre></div>
</div>
</section>
<section id="publisher">
<h2>Publisher<a class="headerlink" href="#publisher" title="Permalink to this heading">¶</a></h2>
<p>Create connection, writergroup, datasetwriter and publisheddataset for
Publisher thread.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"></span>
<span class="nf">addPubSubConnection</span><span class="p">(</span><span class="n">UA_Server</span><span class="w"> </span><span class="o">*</span><span class="n">server</span><span class="p">,</span><span class="w"> </span><span class="n">UA_NetworkAddressUrlDataType</span><span class="w"> </span><span class="o">*</span><span class="n">networkAddressUrlPub</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="cm">/* Details about the connection configuration and handling are located</span>
<span class="cm">     * in the pubsub connection tutorial */</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_PubSubConnectionConfig</span><span class="w"> </span><span class="n">connectionConfig</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">connectionConfig</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">connectionConfig</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="n">connectionConfig</span><span class="p">.</span><span class="n">name</span><span class="w">                                   </span><span class="o">=</span><span class="w"> </span><span class="n">UA_STRING</span><span class="p">(</span><span class="s">&quot;Publisher Connection&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">connectionConfig</span><span class="p">.</span><span class="n">enabled</span><span class="w">                                </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_NetworkAddressUrlDataType</span><span class="w"> </span><span class="n">networkAddressUrl</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">networkAddressUrlPub</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">connectionConfig</span><span class="p">.</span><span class="n">transportProfileUri</span><span class="w">                    </span><span class="o">=</span><span class="w"> </span><span class="n">UA_STRING</span><span class="p">(</span><span class="n">ETH_TRANSPORT_PROFILE</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_Variant_setScalar</span><span class="p">(</span><span class="o">&amp;</span><span class="n">connectionConfig</span><span class="p">.</span><span class="n">address</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">networkAddressUrl</span><span class="p">,</span><span class="w"></span>
<span class="w">                         </span><span class="o">&amp;</span><span class="n">UA_TYPES</span><span class="p">[</span><span class="n">UA_TYPES_NETWORKADDRESSURLDATATYPE</span><span class="p">]);</span><span class="w"></span>
<span class="w">    </span><span class="n">connectionConfig</span><span class="p">.</span><span class="n">publisherId</span><span class="p">.</span><span class="n">numeric</span><span class="w">                    </span><span class="o">=</span><span class="w"> </span><span class="n">PUBLISHER_ID</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="cm">/* Connection options are given as Key/Value Pairs - Sockprio and Txtime */</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_KeyValuePair</span><span class="w"> </span><span class="n">connectionOptions</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="n">connectionOptions</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">key</span><span class="w">                  </span><span class="o">=</span><span class="w"> </span><span class="n">UA_QUALIFIEDNAME</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;sockpriority&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_Variant_setScalar</span><span class="p">(</span><span class="o">&amp;</span><span class="n">connectionOptions</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">socketPriority</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">UA_TYPES</span><span class="p">[</span><span class="n">UA_TYPES_UINT32</span><span class="p">]);</span><span class="w"></span>
<span class="w">    </span><span class="n">connectionOptions</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">key</span><span class="w">                  </span><span class="o">=</span><span class="w"> </span><span class="n">UA_QUALIFIEDNAME</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;enablesotxtime&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_Variant_setScalar</span><span class="p">(</span><span class="o">&amp;</span><span class="n">connectionOptions</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">disableSoTxtime</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">UA_TYPES</span><span class="p">[</span><span class="n">UA_TYPES_BOOLEAN</span><span class="p">]);</span><span class="w"></span>
<span class="w">    </span><span class="n">connectionConfig</span><span class="p">.</span><span class="n">connectionProperties</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="n">connectionOptions</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">connectionConfig</span><span class="p">.</span><span class="n">connectionPropertiesSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">UA_Server_addPubSubConnection</span><span class="p">(</span><span class="n">server</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">connectionConfig</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">connectionIdent</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="cm">/* PublishedDataSet handling */</span><span class="w"></span>
<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"></span>
<span class="nf">addPublishedDataSet</span><span class="p">(</span><span class="n">UA_Server</span><span class="w"> </span><span class="o">*</span><span class="n">server</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_PublishedDataSetConfig</span><span class="w"> </span><span class="n">publishedDataSetConfig</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">publishedDataSetConfig</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">UA_PublishedDataSetConfig</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="n">publishedDataSetConfig</span><span class="p">.</span><span class="n">publishedDataSetType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UA_PUBSUB_DATASET_PUBLISHEDITEMS</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">publishedDataSetConfig</span><span class="p">.</span><span class="n">name</span><span class="w">                 </span><span class="o">=</span><span class="w"> </span><span class="n">UA_STRING</span><span class="p">(</span><span class="s">&quot;Demo PDS&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_Server_addPublishedDataSet</span><span class="p">(</span><span class="n">server</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">publishedDataSetConfig</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">publishedDataSetIdent</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="cm">/* DataSetField handling */</span><span class="w"></span>
<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"></span>
<span class="nf">_addDataSetField</span><span class="p">(</span><span class="n">UA_Server</span><span class="w"> </span><span class="o">*</span><span class="n">server</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="cm">/* Add a field to the previous created PublishedDataSet */</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_NodeId</span><span class="w"> </span><span class="n">dataSetFieldIdentRepeated</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_DataSetFieldConfig</span><span class="w"> </span><span class="n">dataSetFieldConfig</span><span class="p">;</span><span class="w"></span>
<span class="cp">#if defined PUBSUB_CONFIG_FASTPATH_FIXED_OFFSETS</span>
<span class="w">    </span><span class="n">staticValueSource</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UA_DataValue_new</span><span class="p">();</span><span class="w"></span>
<span class="cp">#endif</span>

<span class="w">    </span><span class="n">UA_NodeId</span><span class="w"> </span><span class="n">dataSetFieldIdentRunning</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_DataSetFieldConfig</span><span class="w"> </span><span class="n">dsfConfigPubStatus</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsfConfigPubStatus</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">UA_DataSetFieldConfig</span><span class="p">));</span><span class="w"></span>

<span class="w">    </span><span class="n">runningPub</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UA_Boolean_new</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">runningPub</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">UA_LOG_ERROR</span><span class="p">(</span><span class="n">UA_Log_Stdout</span><span class="p">,</span><span class="w"> </span><span class="n">UA_LOGCATEGORY_SERVER</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;runningPub - Bad out of memory&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="o">*</span><span class="n">runningPub</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">runningPubDataValueRT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UA_DataValue_new</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">runningPubDataValueRT</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">UA_LOG_ERROR</span><span class="p">(</span><span class="n">UA_Log_Stdout</span><span class="p">,</span><span class="w"> </span><span class="n">UA_LOGCATEGORY_SERVER</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;runningPubDataValue - Bad out of memory&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">UA_Variant_setScalar</span><span class="p">(</span><span class="o">&amp;</span><span class="n">runningPubDataValueRT</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">runningPub</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">UA_TYPES</span><span class="p">[</span><span class="n">UA_TYPES_BOOLEAN</span><span class="p">]);</span><span class="w"></span>
<span class="w">    </span><span class="n">runningPubDataValueRT</span><span class="o">-&gt;</span><span class="n">hasValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="cm">/* Set the value backend of the above create node to &#39;external value source&#39; */</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_ValueBackend</span><span class="w"> </span><span class="n">runningPubvalueBackend</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">runningPubvalueBackend</span><span class="p">.</span><span class="n">backendType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UA_VALUEBACKENDTYPE_EXTERNAL</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">runningPubvalueBackend</span><span class="p">.</span><span class="n">backend</span><span class="p">.</span><span class="n">external</span><span class="p">.</span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">runningPubDataValueRT</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">runningPubvalueBackend</span><span class="p">.</span><span class="n">backend</span><span class="p">.</span><span class="n">external</span><span class="p">.</span><span class="n">callback</span><span class="p">.</span><span class="n">userWrite</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">externalDataWriteCallback</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">runningPubvalueBackend</span><span class="p">.</span><span class="n">backend</span><span class="p">.</span><span class="n">external</span><span class="p">.</span><span class="n">callback</span><span class="p">.</span><span class="n">notificationRead</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">externalDataReadNotificationCallback</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_Server_setVariableNode_valueBackend</span><span class="p">(</span><span class="n">server</span><span class="p">,</span><span class="w"> </span><span class="n">UA_NODEID_NUMERIC</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">UA_UInt32</span><span class="p">)</span><span class="mi">20000</span><span class="p">),</span><span class="w"> </span><span class="n">runningPubvalueBackend</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="cm">/* setup RT DataSetField config */</span><span class="w"></span>
<span class="w">    </span><span class="n">dsfConfigPubStatus</span><span class="p">.</span><span class="n">field</span><span class="p">.</span><span class="n">variable</span><span class="p">.</span><span class="n">rtValueSource</span><span class="p">.</span><span class="n">rtInformationModelNode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">dsfConfigPubStatus</span><span class="p">.</span><span class="n">field</span><span class="p">.</span><span class="n">variable</span><span class="p">.</span><span class="n">publishParameters</span><span class="p">.</span><span class="n">publishedVariable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UA_NODEID_NUMERIC</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">UA_UInt32</span><span class="p">)</span><span class="mi">20000</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">UA_Server_addDataSetField</span><span class="p">(</span><span class="n">server</span><span class="p">,</span><span class="w"> </span><span class="n">publishedDataSetIdent</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">dsfConfigPubStatus</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">dataSetFieldIdentRunning</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="n">UA_Int32</span><span class="w"> </span><span class="n">iterator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">iterator</span><span class="w"> </span><span class="o">&lt;</span><span class="w">  </span><span class="n">REPEATED_NODECOUNTS</span><span class="p">;</span><span class="w"> </span><span class="n">iterator</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">       </span><span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dataSetFieldConfig</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">UA_DataSetFieldConfig</span><span class="p">));</span><span class="w"></span>

<span class="w">       </span><span class="n">repeatedCounterData</span><span class="p">[</span><span class="n">iterator</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UA_UInt64_new</span><span class="p">();</span><span class="w"></span>
<span class="w">       </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">repeatedCounterData</span><span class="p">[</span><span class="n">iterator</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">           </span><span class="n">UA_LOG_ERROR</span><span class="p">(</span><span class="n">UA_Log_Stdout</span><span class="p">,</span><span class="w"> </span><span class="n">UA_LOGCATEGORY_SERVER</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;PublishRepeatedCounter - Bad out of memory&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">           </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">       </span><span class="p">}</span><span class="w"></span>

<span class="w">       </span><span class="o">*</span><span class="n">repeatedCounterData</span><span class="p">[</span><span class="n">iterator</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">       </span><span class="n">repeatedDataValueRT</span><span class="p">[</span><span class="n">iterator</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UA_DataValue_new</span><span class="p">();</span><span class="w"></span>
<span class="w">       </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">repeatedDataValueRT</span><span class="p">[</span><span class="n">iterator</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">           </span><span class="n">UA_LOG_ERROR</span><span class="p">(</span><span class="n">UA_Log_Stdout</span><span class="p">,</span><span class="w"> </span><span class="n">UA_LOGCATEGORY_SERVER</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;PublishRepeatedCounterDataValue - Bad out of memory&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">           </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">       </span><span class="p">}</span><span class="w"></span>

<span class="w">       </span><span class="n">UA_Variant_setScalar</span><span class="p">(</span><span class="o">&amp;</span><span class="n">repeatedDataValueRT</span><span class="p">[</span><span class="n">iterator</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">repeatedCounterData</span><span class="p">[</span><span class="n">iterator</span><span class="p">],</span><span class="w"> </span><span class="o">&amp;</span><span class="n">UA_TYPES</span><span class="p">[</span><span class="n">UA_TYPES_UINT64</span><span class="p">]);</span><span class="w"></span>
<span class="w">       </span><span class="n">repeatedDataValueRT</span><span class="p">[</span><span class="n">iterator</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">hasValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>

<span class="w">       </span><span class="cm">/* Set the value backend of the above create node to &#39;external value source&#39; */</span><span class="w"></span>
<span class="w">       </span><span class="n">UA_ValueBackend</span><span class="w"> </span><span class="n">valueBackend</span><span class="p">;</span><span class="w"></span>
<span class="w">       </span><span class="n">valueBackend</span><span class="p">.</span><span class="n">backendType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UA_VALUEBACKENDTYPE_EXTERNAL</span><span class="p">;</span><span class="w"></span>
<span class="w">       </span><span class="n">valueBackend</span><span class="p">.</span><span class="n">backend</span><span class="p">.</span><span class="n">external</span><span class="p">.</span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">repeatedDataValueRT</span><span class="p">[</span><span class="n">iterator</span><span class="p">];</span><span class="w"></span>
<span class="w">       </span><span class="n">valueBackend</span><span class="p">.</span><span class="n">backend</span><span class="p">.</span><span class="n">external</span><span class="p">.</span><span class="n">callback</span><span class="p">.</span><span class="n">userWrite</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">externalDataWriteCallback</span><span class="p">;</span><span class="w"></span>
<span class="w">       </span><span class="n">valueBackend</span><span class="p">.</span><span class="n">backend</span><span class="p">.</span><span class="n">external</span><span class="p">.</span><span class="n">callback</span><span class="p">.</span><span class="n">notificationRead</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">externalDataReadNotificationCallback</span><span class="p">;</span><span class="w"></span>
<span class="w">       </span><span class="n">UA_Server_setVariableNode_valueBackend</span><span class="p">(</span><span class="n">server</span><span class="p">,</span><span class="w"> </span><span class="n">UA_NODEID_NUMERIC</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">UA_UInt32</span><span class="p">)</span><span class="n">iterator</span><span class="o">+</span><span class="mi">10000</span><span class="p">),</span><span class="w"> </span><span class="n">valueBackend</span><span class="p">);</span><span class="w"></span>

<span class="w">       </span><span class="cm">/* setup RT DataSetField config */</span><span class="w"></span>
<span class="w">       </span><span class="n">dataSetFieldConfig</span><span class="p">.</span><span class="n">field</span><span class="p">.</span><span class="n">variable</span><span class="p">.</span><span class="n">rtValueSource</span><span class="p">.</span><span class="n">rtInformationModelNode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">       </span><span class="n">dataSetFieldConfig</span><span class="p">.</span><span class="n">field</span><span class="p">.</span><span class="n">variable</span><span class="p">.</span><span class="n">publishParameters</span><span class="p">.</span><span class="n">publishedVariable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UA_NODEID_NUMERIC</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">UA_UInt32</span><span class="p">)</span><span class="n">iterator</span><span class="o">+</span><span class="mi">10000</span><span class="p">);</span><span class="w"></span>
<span class="w">       </span><span class="n">UA_Server_addDataSetField</span><span class="p">(</span><span class="n">server</span><span class="p">,</span><span class="w"> </span><span class="n">publishedDataSetIdent</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">dataSetFieldConfig</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">dataSetFieldIdentRepeated</span><span class="p">);</span><span class="w"></span>
<span class="w">   </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">UA_NodeId</span><span class="w"> </span><span class="n">dataSetFieldIdent</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_DataSetFieldConfig</span><span class="w"> </span><span class="n">dsfConfig</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsfConfig</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">UA_DataSetFieldConfig</span><span class="p">));</span><span class="w"></span>

<span class="w">    </span><span class="n">pubCounterData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UA_UInt64_new</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">pubCounterData</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">UA_LOG_ERROR</span><span class="p">(</span><span class="n">UA_Log_Stdout</span><span class="p">,</span><span class="w"> </span><span class="n">UA_LOGCATEGORY_SERVER</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;PublishCounter - Bad out of memory&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="o">*</span><span class="n">pubCounterData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">pubDataValueRT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UA_DataValue_new</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">pubDataValueRT</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">UA_LOG_ERROR</span><span class="p">(</span><span class="n">UA_Log_Stdout</span><span class="p">,</span><span class="w"> </span><span class="n">UA_LOGCATEGORY_SERVER</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;PublishDataValue - Bad out of memory&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">UA_Variant_setScalar</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pubDataValueRT</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">pubCounterData</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">UA_TYPES</span><span class="p">[</span><span class="n">UA_TYPES_UINT64</span><span class="p">]);</span><span class="w"></span>
<span class="w">    </span><span class="n">pubDataValueRT</span><span class="o">-&gt;</span><span class="n">hasValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="cm">/* Set the value backend of the above create node to &#39;external value source&#39; */</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_ValueBackend</span><span class="w"> </span><span class="n">valueBackend</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">valueBackend</span><span class="p">.</span><span class="n">backendType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UA_VALUEBACKENDTYPE_EXTERNAL</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">valueBackend</span><span class="p">.</span><span class="n">backend</span><span class="p">.</span><span class="n">external</span><span class="p">.</span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pubDataValueRT</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">valueBackend</span><span class="p">.</span><span class="n">backend</span><span class="p">.</span><span class="n">external</span><span class="p">.</span><span class="n">callback</span><span class="p">.</span><span class="n">userWrite</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">externalDataWriteCallback</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">valueBackend</span><span class="p">.</span><span class="n">backend</span><span class="p">.</span><span class="n">external</span><span class="p">.</span><span class="n">callback</span><span class="p">.</span><span class="n">notificationRead</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">externalDataReadNotificationCallback</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_Server_setVariableNode_valueBackend</span><span class="p">(</span><span class="n">server</span><span class="p">,</span><span class="w"> </span><span class="n">pubNodeID</span><span class="p">,</span><span class="w"> </span><span class="n">valueBackend</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="cm">/* setup RT DataSetField config */</span><span class="w"></span>
<span class="w">    </span><span class="n">dsfConfig</span><span class="p">.</span><span class="n">field</span><span class="p">.</span><span class="n">variable</span><span class="p">.</span><span class="n">rtValueSource</span><span class="p">.</span><span class="n">rtInformationModelNode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">dsfConfig</span><span class="p">.</span><span class="n">field</span><span class="p">.</span><span class="n">variable</span><span class="p">.</span><span class="n">publishParameters</span><span class="p">.</span><span class="n">publishedVariable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pubNodeID</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">UA_Server_addDataSetField</span><span class="p">(</span><span class="n">server</span><span class="p">,</span><span class="w"> </span><span class="n">publishedDataSetIdent</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">dsfConfig</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">dataSetFieldIdent</span><span class="p">);</span><span class="w"></span>

<span class="p">}</span><span class="w"></span>

<span class="cm">/* WriterGroup handling */</span><span class="w"></span>
<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"></span>
<span class="nf">addWriterGroup</span><span class="p">(</span><span class="n">UA_Server</span><span class="w"> </span><span class="o">*</span><span class="n">server</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_WriterGroupConfig</span><span class="w"> </span><span class="n">writerGroupConfig</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">writerGroupConfig</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">UA_WriterGroupConfig</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="n">writerGroupConfig</span><span class="p">.</span><span class="n">name</span><span class="w">               </span><span class="o">=</span><span class="w"> </span><span class="n">UA_STRING</span><span class="p">(</span><span class="s">&quot;Demo WriterGroup&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">writerGroupConfig</span><span class="p">.</span><span class="n">publishingInterval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cycleTimeInMsec</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">writerGroupConfig</span><span class="p">.</span><span class="n">enabled</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">writerGroupConfig</span><span class="p">.</span><span class="n">encodingMimeType</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">UA_PUBSUB_ENCODING_UADP</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">writerGroupConfig</span><span class="p">.</span><span class="n">writerGroupId</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="n">WRITER_GROUP_ID</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">writerGroupConfig</span><span class="p">.</span><span class="n">rtLevel</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="n">UA_PUBSUB_RT_FIXED_SIZE</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">writerGroupConfig</span><span class="p">.</span><span class="n">pubsubManagerCallback</span><span class="p">.</span><span class="n">addCustomCallback</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">addPubSubApplicationCallback</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">writerGroupConfig</span><span class="p">.</span><span class="n">pubsubManagerCallback</span><span class="p">.</span><span class="n">changeCustomCallback</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">changePubSubApplicationCallback</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">writerGroupConfig</span><span class="p">.</span><span class="n">pubsubManagerCallback</span><span class="p">.</span><span class="n">removeCustomCallback</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">removePubSubApplicationCallback</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">writerGroupConfig</span><span class="p">.</span><span class="n">messageSettings</span><span class="p">.</span><span class="n">encoding</span><span class="w">             </span><span class="o">=</span><span class="w"> </span><span class="n">UA_EXTENSIONOBJECT_DECODED</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">writerGroupConfig</span><span class="p">.</span><span class="n">messageSettings</span><span class="p">.</span><span class="n">content</span><span class="p">.</span><span class="n">decoded</span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">UA_TYPES</span><span class="p">[</span><span class="n">UA_TYPES_UADPWRITERGROUPMESSAGEDATATYPE</span><span class="p">];</span><span class="w"></span>

<span class="cp">#ifdef UA_ENABLE_PUBSUB_ENCRYPTION</span>
<span class="w">    </span><span class="n">UA_ServerConfig</span><span class="w"> </span><span class="o">*</span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UA_Server_getConfig</span><span class="p">(</span><span class="n">server</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">writerGroupConfig</span><span class="p">.</span><span class="n">securityMode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UA_MESSAGESECURITYMODE_SIGNANDENCRYPT</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">writerGroupConfig</span><span class="p">.</span><span class="n">securityPolicy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">pubSubConfig</span><span class="p">.</span><span class="n">securityPolicies</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="w"></span>
<span class="cp">#endif</span>

<span class="w">    </span><span class="cm">/* The configuration flags for the messages are encapsulated inside the</span>
<span class="cm">     * message- and transport settings extension objects. These extension</span>
<span class="cm">     * objects are defined by the standard. e.g.</span>
<span class="cm">     * UadpWriterGroupMessageDataType */</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_UadpWriterGroupMessageDataType</span><span class="w"> </span><span class="o">*</span><span class="n">writerGroupMessage</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">UA_UadpWriterGroupMessageDataType_new</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="cm">/* Change message settings of writerGroup to send PublisherId,</span>
<span class="cm">     * WriterGroupId in GroupHeader and DataSetWriterId in PayloadHeader</span>
<span class="cm">     * of NetworkMessage */</span><span class="w"></span>
<span class="w">    </span><span class="n">writerGroupMessage</span><span class="o">-&gt;</span><span class="n">networkMessageContentMask</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="n">UA_UadpNetworkMessageContentMask</span><span class="p">)(</span><span class="n">UA_UADPNETWORKMESSAGECONTENTMASK_PUBLISHERID</span><span class="w"> </span><span class="o">|</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="n">UA_UadpNetworkMessageContentMask</span><span class="p">)</span><span class="n">UA_UADPNETWORKMESSAGECONTENTMASK_GROUPHEADER</span><span class="w"> </span><span class="o">|</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="n">UA_UadpNetworkMessageContentMask</span><span class="p">)</span><span class="n">UA_UADPNETWORKMESSAGECONTENTMASK_WRITERGROUPID</span><span class="w"> </span><span class="o">|</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="n">UA_UadpNetworkMessageContentMask</span><span class="p">)</span><span class="n">UA_UADPNETWORKMESSAGECONTENTMASK_PAYLOADHEADER</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">writerGroupConfig</span><span class="p">.</span><span class="n">messageSettings</span><span class="p">.</span><span class="n">content</span><span class="p">.</span><span class="n">decoded</span><span class="p">.</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">writerGroupMessage</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_Server_addWriterGroup</span><span class="p">(</span><span class="n">server</span><span class="p">,</span><span class="w"> </span><span class="n">connectionIdent</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">writerGroupConfig</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">writerGroupIdent</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_Server_setWriterGroupOperational</span><span class="p">(</span><span class="n">server</span><span class="p">,</span><span class="w"> </span><span class="n">writerGroupIdent</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_UadpWriterGroupMessageDataType_delete</span><span class="p">(</span><span class="n">writerGroupMessage</span><span class="p">);</span><span class="w"></span>

<span class="cp">#ifdef UA_ENABLE_PUBSUB_ENCRYPTION</span>
<span class="w">    </span><span class="cm">/* Add the encryption key informaton */</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_ByteString</span><span class="w"> </span><span class="n">sk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">UA_AES128CTR_SIGNING_KEY_LENGTH</span><span class="p">,</span><span class="w"> </span><span class="n">signingKeyPub</span><span class="p">};</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_ByteString</span><span class="w"> </span><span class="n">ek</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">UA_AES128CTR_KEY_LENGTH</span><span class="p">,</span><span class="w"> </span><span class="n">encryptingKeyPub</span><span class="p">};</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_ByteString</span><span class="w"> </span><span class="n">kn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">UA_AES128CTR_KEYNONCE_LENGTH</span><span class="p">,</span><span class="w"> </span><span class="n">keyNoncePub</span><span class="p">};</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_Server_setWriterGroupEncryptionKeys</span><span class="p">(</span><span class="n">server</span><span class="p">,</span><span class="w"> </span><span class="n">writerGroupIdent</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">sk</span><span class="p">,</span><span class="w"> </span><span class="n">ek</span><span class="p">,</span><span class="w"> </span><span class="n">kn</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="p">}</span><span class="w"></span>

<span class="cm">/* DataSetWriter handling */</span><span class="w"></span>
<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"></span>
<span class="nf">addDataSetWriter</span><span class="p">(</span><span class="n">UA_Server</span><span class="w"> </span><span class="o">*</span><span class="n">server</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_NodeId</span><span class="w"> </span><span class="n">dataSetWriterIdent</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_DataSetWriterConfig</span><span class="w"> </span><span class="n">dataSetWriterConfig</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dataSetWriterConfig</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">UA_DataSetWriterConfig</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="n">dataSetWriterConfig</span><span class="p">.</span><span class="n">name</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="n">UA_STRING</span><span class="p">(</span><span class="s">&quot;Demo DataSetWriter&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">dataSetWriterConfig</span><span class="p">.</span><span class="n">dataSetWriterId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DATA_SET_WRITER_ID</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">dataSetWriterConfig</span><span class="p">.</span><span class="n">keyFrameCount</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_Server_addDataSetWriter</span><span class="p">(</span><span class="n">server</span><span class="p">,</span><span class="w"> </span><span class="n">writerGroupIdent</span><span class="p">,</span><span class="w"> </span><span class="n">publishedDataSetIdent</span><span class="p">,</span><span class="w"></span>
<span class="w">                               </span><span class="o">&amp;</span><span class="n">dataSetWriterConfig</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">dataSetWriterIdent</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="published-data-handling">
<h2>Published data handling<a class="headerlink" href="#published-data-handling" title="Permalink to this heading">¶</a></h2>
<p>The published data is updated in the array using this function.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#if defined(PUBLISHER)</span>
<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"></span>
<span class="nf">updateMeasurementsPublisher</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">timespec</span><span class="w"> </span><span class="n">start_time</span><span class="p">,</span><span class="w"></span>
<span class="w">                            </span><span class="n">UA_UInt64</span><span class="w"> </span><span class="n">counterValue</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">measurementsPublisher</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">MAX_MEASUREMENTS</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">UA_LOG_INFO</span><span class="p">(</span><span class="n">UA_Log_Stdout</span><span class="p">,</span><span class="w"> </span><span class="n">UA_LOGCATEGORY_SERVER</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="s">&quot;Publisher: Maximum log measurements reached - Closing the application&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">signalTerm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">consolePrint</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">UA_LOG_INFO</span><span class="p">(</span><span class="n">UA_Log_Stdout</span><span class="p">,</span><span class="w"> </span><span class="n">UA_LOGCATEGORY_USERLAND</span><span class="p">,</span><span class="s">&quot;Pub:%lu,%ld.%09ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="kt">unsigned</span><span class="p">)</span><span class="n">counterValue</span><span class="p">,</span><span class="w"> </span><span class="n">start_time</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">,</span><span class="w"> </span><span class="n">start_time</span><span class="p">.</span><span class="n">tv_nsec</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">signalTerm</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">true</span><span class="p">){</span><span class="w"></span>
<span class="w">        </span><span class="n">publishTimestamp</span><span class="p">[</span><span class="n">measurementsPublisher</span><span class="p">]</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="n">start_time</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">publishCounterValue</span><span class="p">[</span><span class="n">measurementsPublisher</span><span class="p">]</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="n">counterValue</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">measurementsPublisher</span><span class="o">++</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="cp">#if defined(SUBSCRIBER)</span>
</pre></div>
</div>
</section>
<section id="subscribed-data-handling">
<h2>Subscribed data handling<a class="headerlink" href="#subscribed-data-handling" title="Permalink to this heading">¶</a></h2>
<p>The subscribed data is updated in the array using this function Subscribed
data handling.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"></span>
<span class="nf">updateMeasurementsSubscriber</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">timespec</span><span class="w"> </span><span class="n">receive_time</span><span class="p">,</span><span class="w"></span>
<span class="w">                             </span><span class="n">UA_UInt64</span><span class="w"> </span><span class="n">counterValue</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">measurementsSubscriber</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">MAX_MEASUREMENTS</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">UA_LOG_INFO</span><span class="p">(</span><span class="n">UA_Log_Stdout</span><span class="p">,</span><span class="w"> </span><span class="n">UA_LOGCATEGORY_SERVER</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="s">&quot;Subscriber: Maximum log measurements reached - Closing the application&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">signalTerm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">consolePrint</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">UA_LOG_INFO</span><span class="p">(</span><span class="n">UA_Log_Stdout</span><span class="p">,</span><span class="w"> </span><span class="n">UA_LOGCATEGORY_USERLAND</span><span class="p">,</span><span class="s">&quot;Sub:%lu,%ld.%09ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="kt">unsigned</span><span class="p">)</span><span class="n">counterValue</span><span class="p">,</span><span class="w"> </span><span class="n">receive_time</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">,</span><span class="w"> </span><span class="n">receive_time</span><span class="p">.</span><span class="n">tv_nsec</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">signalTerm</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">true</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">subscribeTimestamp</span><span class="p">[</span><span class="n">measurementsSubscriber</span><span class="p">]</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="n">receive_time</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">subscribeCounterValue</span><span class="p">[</span><span class="n">measurementsSubscriber</span><span class="p">]</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">counterValue</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">measurementsSubscriber</span><span class="o">++</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="cp">#endif</span>
</pre></div>
</div>
</section>
<section id="publisher-thread-routine">
<h2>Publisher thread routine<a class="headerlink" href="#publisher-thread-routine" title="Permalink to this heading">¶</a></h2>
<p>This is the Publisher thread that sleeps for 60% of the cycletime (250us) and
prepares the tranmission packet within 40% of cycletime. The priority of this
thread is lower than the priority of the Subscriber thread, so the subscriber
thread executes first during every cycle. The data published by this thread
in one cycle is subscribed by the subscriber thread of pubsub_TSN_loopback in
the next cycle(two cycle timing model).</p>
<p>The publisherETF function is the routine used by the publisher thread.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="nf">publisherETF</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">arg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">timespec</span><span class="w">   </span><span class="n">nextnanosleeptime</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_ServerCallback</span><span class="w"> </span><span class="n">pubCallback</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_Server</span><span class="o">*</span><span class="w">        </span><span class="n">server</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_WriterGroup</span><span class="o">*</span><span class="w">   </span><span class="n">currentWriterGroup</span><span class="p">;</span><span class="w"> </span><span class="c1">// TODO: Remove WriterGroup Usage</span>
<span class="w">    </span><span class="n">UA_UInt64</span><span class="w">         </span><span class="n">interval_ns</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_UInt64</span><span class="w">         </span><span class="n">transmission_time</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">threadArg</span><span class="w"> </span><span class="o">*</span><span class="n">threadArgumentsPublisher</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">threadArg</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">server</span><span class="w">                              </span><span class="o">=</span><span class="w"> </span><span class="n">threadArgumentsPublisher</span><span class="o">-&gt;</span><span class="n">server</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">pubCallback</span><span class="w">                         </span><span class="o">=</span><span class="w"> </span><span class="n">threadArgumentsPublisher</span><span class="o">-&gt;</span><span class="n">callback</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">currentWriterGroup</span><span class="w">                  </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">UA_WriterGroup</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">threadArgumentsPublisher</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">interval_ns</span><span class="w">                         </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">UA_UInt64</span><span class="p">)(</span><span class="n">threadArgumentsPublisher</span><span class="o">-&gt;</span><span class="n">interval_ms</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">MILLI_SECONDS</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="cm">/* Verify whether baseTime has already been calculated */</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">baseTimeCalculated</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="cm">/* Get current time and compute the next nanosleeptime */</span><span class="w"></span>
<span class="w">        </span><span class="n">clock_gettime</span><span class="p">(</span><span class="n">CLOCKID</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">threadBaseTime</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="cm">/* Variable to nano Sleep until SECONDS_SLEEP second boundary */</span><span class="w"></span>
<span class="w">        </span><span class="n">threadBaseTime</span><span class="p">.</span><span class="n">tv_sec</span><span class="w">  </span><span class="o">+=</span><span class="w"> </span><span class="n">SECONDS_SLEEP</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">threadBaseTime</span><span class="p">.</span><span class="n">tv_nsec</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">baseTimeCalculated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">nextnanosleeptime</span><span class="p">.</span><span class="n">tv_sec</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">threadBaseTime</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="cm">/* Modify the nanosecond field to wake up at the pubWakeUp percentage */</span><span class="w"></span>
<span class="w">    </span><span class="n">nextnanosleeptime</span><span class="p">.</span><span class="n">tv_nsec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">threadBaseTime</span><span class="p">.</span><span class="n">tv_nsec</span><span class="w"> </span><span class="o">+</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="n">__syscall_slong_t</span><span class="p">)(</span><span class="n">cycleTimeInMsec</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">MILLI_SECONDS</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">pubWakeupPercentage</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">nanoSecondFieldConversion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nextnanosleeptime</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="cm">/* Define Ethernet ETF transport settings */</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_EthernetWriterGroupTransportDataType</span><span class="w"> </span><span class="n">ethernettransportSettings</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ethernettransportSettings</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">UA_EthernetWriterGroupTransportDataType</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="n">ethernettransportSettings</span><span class="p">.</span><span class="n">transmission_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="cm">/* Encapsulate ETF config in transportSettings */</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_ExtensionObject</span><span class="w"> </span><span class="n">transportSettings</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">transportSettings</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">UA_ExtensionObject</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="cm">/* TODO: transportSettings encoding and type to be defined */</span><span class="w"></span>
<span class="w">    </span><span class="n">transportSettings</span><span class="p">.</span><span class="n">content</span><span class="p">.</span><span class="n">decoded</span><span class="p">.</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ethernettransportSettings</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">currentWriterGroup</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">transportSettings</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">transportSettings</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_UInt64</span><span class="w"> </span><span class="n">roundOffCycleTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">UA_UInt64</span><span class="p">)((</span><span class="n">cycleTimeInMsec</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">MILLI_SECONDS</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"></span>
<span class="w">                                              </span><span class="p">(</span><span class="n">cycleTimeInMsec</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">MILLI_SECONDS</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">pubWakeupPercentage</span><span class="p">));</span><span class="w"></span>

<span class="w">    </span><span class="k">while</span><span class="p">(</span><span class="o">*</span><span class="n">runningPub</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="cm">/* The Publisher threads wakes up at the configured publisher wake up</span>
<span class="cm">         * percentage (60%) of each cycle */</span><span class="w"></span>
<span class="w">        </span><span class="n">clock_nanosleep</span><span class="p">(</span><span class="n">CLOCKID</span><span class="p">,</span><span class="w"> </span><span class="n">TIMER_ABSTIME</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">nextnanosleeptime</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="cm">/* Whenever Ctrl + C pressed, publish running boolean as false to stop</span>
<span class="cm">         * the subscriber before terminating the application */</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">signalTerm</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">true</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="o">*</span><span class="n">runningPub</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="cm">/* Calculation of transmission time using the configured qbv offset by</span>
<span class="cm">         * the user - Will be handled by publishingOffset in the future */</span><span class="w"></span>
<span class="w">        </span><span class="n">transmission_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">UA_UInt64</span><span class="p">)</span><span class="n">nextnanosleeptime</span><span class="p">.</span><span class="n">tv_sec</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">SECONDS</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">UA_UInt64</span><span class="p">)</span><span class="n">nextnanosleeptime</span><span class="p">.</span><span class="n">tv_nsec</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"></span>
<span class="w">            </span><span class="n">roundOffCycleTime</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">UA_UInt64</span><span class="p">)(</span><span class="n">qbvOffset</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1000</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">ethernettransportSettings</span><span class="p">.</span><span class="n">transmission_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">transmission_time</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="cm">/* Publish the data using the pubcallback - UA_WriterGroup_publishCallback() */</span><span class="w"></span>
<span class="w">        </span><span class="n">pubCallback</span><span class="p">(</span><span class="n">server</span><span class="p">,</span><span class="w"> </span><span class="n">currentWriterGroup</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="cm">/* Calculation of the next wake up time by adding the interval with the previous wake up time */</span><span class="w"></span>
<span class="w">        </span><span class="n">nextnanosleeptime</span><span class="p">.</span><span class="n">tv_nsec</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="p">(</span><span class="n">__syscall_slong_t</span><span class="p">)</span><span class="n">interval_ns</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">nanoSecondFieldConversion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nextnanosleeptime</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="cp">#if defined(PUBLISHER) &amp;&amp; !defined(SUBSCRIBER)</span>
<span class="w">    </span><span class="n">runningServer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UA_FALSE</span><span class="p">;</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">    </span><span class="n">UA_free</span><span class="p">(</span><span class="n">threadArgumentsPublisher</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="cp">#endif</span>

<span class="cp">#if defined(SUBSCRIBER)</span>
</pre></div>
</div>
</section>
<section id="subscriber-thread-routine">
<h2>Subscriber thread routine<a class="headerlink" href="#subscriber-thread-routine" title="Permalink to this heading">¶</a></h2>
<p>This Subscriber thread will wakeup during the start of cycle at 250us
interval and check if the packets are received. Subscriber thread has the
highest priority. This Subscriber thread subscribes to the data published by
the Publisher thread of pubsub_TSN_loopback in the previous cycle. The
subscriber function is the routine used by the subscriber thread.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="nf">subscriber</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">arg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_Server</span><span class="o">*</span><span class="w">        </span><span class="n">server</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">void</span><span class="o">*</span><span class="w">             </span><span class="n">currentReaderGroup</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_ServerCallback</span><span class="w"> </span><span class="n">subCallback</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">timespec</span><span class="w">   </span><span class="n">nextnanosleeptimeSub</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_UInt64</span><span class="w">         </span><span class="n">subInterval_ns</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">threadArg</span><span class="w"> </span><span class="o">*</span><span class="n">threadArgumentsSubscriber</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">threadArg</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">server</span><span class="w">             </span><span class="o">=</span><span class="w"> </span><span class="n">threadArgumentsSubscriber</span><span class="o">-&gt;</span><span class="n">server</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">subCallback</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="n">threadArgumentsSubscriber</span><span class="o">-&gt;</span><span class="n">callback</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">currentReaderGroup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">threadArgumentsSubscriber</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">subInterval_ns</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">UA_UInt64</span><span class="p">)(</span><span class="n">threadArgumentsSubscriber</span><span class="o">-&gt;</span><span class="n">interval_ms</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">MILLI_SECONDS</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="cm">/* Verify whether baseTime has already been calculated */</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">baseTimeCalculated</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="cm">/* Get current time and compute the next nanosleeptime */</span><span class="w"></span>
<span class="w">        </span><span class="n">clock_gettime</span><span class="p">(</span><span class="n">CLOCKID</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">threadBaseTime</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="cm">/* Variable to nano Sleep until SECONDS_SLEEP second boundary */</span><span class="w"></span>
<span class="w">        </span><span class="n">threadBaseTime</span><span class="p">.</span><span class="n">tv_sec</span><span class="w">  </span><span class="o">+=</span><span class="w"> </span><span class="n">SECONDS_SLEEP</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">threadBaseTime</span><span class="p">.</span><span class="n">tv_nsec</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">baseTimeCalculated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">nextnanosleeptimeSub</span><span class="p">.</span><span class="n">tv_sec</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">threadBaseTime</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="cm">/* Modify the nanosecond field to wake up at the subWakeUp percentage */</span><span class="w"></span>
<span class="w">    </span><span class="n">nextnanosleeptimeSub</span><span class="p">.</span><span class="n">tv_nsec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">threadBaseTime</span><span class="p">.</span><span class="n">tv_nsec</span><span class="w"> </span><span class="o">+</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="n">__syscall_slong_t</span><span class="p">)(</span><span class="n">cycleTimeInMsec</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">MILLI_SECONDS</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">subWakeupPercentage</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">nanoSecondFieldConversion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nextnanosleeptimeSub</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">while</span><span class="p">(</span><span class="o">*</span><span class="n">runningSub</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="cm">/* The Subscriber threads wakes up at the configured subscriber wake up percentage (0%) of each cycle */</span><span class="w"></span>
<span class="w">        </span><span class="n">clock_nanosleep</span><span class="p">(</span><span class="n">CLOCKID</span><span class="p">,</span><span class="w"> </span><span class="n">TIMER_ABSTIME</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">nextnanosleeptimeSub</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="cm">/* Receive and process the incoming data using the subcallback - UA_ReaderGroup_subscribeCallback() */</span><span class="w"></span>
<span class="w">        </span><span class="n">subCallback</span><span class="p">(</span><span class="n">server</span><span class="p">,</span><span class="w"> </span><span class="n">currentReaderGroup</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="cm">/* Calculation of the next wake up time by adding the interval with the previous wake up time */</span><span class="w"></span>
<span class="w">        </span><span class="n">nextnanosleeptimeSub</span><span class="p">.</span><span class="n">tv_nsec</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="p">(</span><span class="n">__syscall_slong_t</span><span class="p">)</span><span class="n">subInterval_ns</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">nanoSecondFieldConversion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nextnanosleeptimeSub</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="cm">/* Whenever Ctrl + C pressed, modify the runningSub boolean to false to end this while loop */</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">signalTerm</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">true</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="o">*</span><span class="n">runningSub</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">UA_free</span><span class="p">(</span><span class="n">threadArgumentsSubscriber</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="cm">/* While ctrl+c is provided in publisher side then loopback application</span>
<span class="cm">     * need to be closed by after sending *running=0 for subscriber T4 */</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="o">*</span><span class="n">runningSub</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">false</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">signalTerm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">runningServer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="cp">#endif</span>

<span class="cp">#if defined(PUBLISHER) || defined(SUBSCRIBER)</span>
</pre></div>
</div>
</section>
<section id="userapplication-thread-routine">
<h2>UserApplication thread routine<a class="headerlink" href="#userapplication-thread-routine" title="Permalink to this heading">¶</a></h2>
<p>The userapplication thread will wakeup at 30% of cycle time and handles the
userdata(read and write in Information Model). This thread serves the purpose
of a Control loop, which is used to increment the counterdata to be published
by the Publisher thread and read the data from Information Model for the
Subscriber thread and writes the updated counterdata in distinct csv files
for both threads.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="nf">userApplicationPubSub</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">arg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_UInt64</span><span class="w">  </span><span class="n">repeatedCounterValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">timespec</span><span class="w"> </span><span class="n">nextnanosleeptimeUserApplication</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="cm">/* Verify whether baseTime has already been calculated */</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">baseTimeCalculated</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="cm">/* Get current time and compute the next nanosleeptime */</span><span class="w"></span>
<span class="w">        </span><span class="n">clock_gettime</span><span class="p">(</span><span class="n">CLOCKID</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">threadBaseTime</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="cm">/* Variable to nano Sleep until SECONDS_SLEEP second boundary */</span><span class="w"></span>
<span class="w">        </span><span class="n">threadBaseTime</span><span class="p">.</span><span class="n">tv_sec</span><span class="w">  </span><span class="o">+=</span><span class="w"> </span><span class="n">SECONDS_SLEEP</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">threadBaseTime</span><span class="p">.</span><span class="n">tv_nsec</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">baseTimeCalculated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">nextnanosleeptimeUserApplication</span><span class="p">.</span><span class="n">tv_sec</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">threadBaseTime</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="cm">/* Modify the nanosecond field to wake up at the userAppWakeUp percentage */</span><span class="w"></span>
<span class="w">    </span><span class="n">nextnanosleeptimeUserApplication</span><span class="p">.</span><span class="n">tv_nsec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">threadBaseTime</span><span class="p">.</span><span class="n">tv_nsec</span><span class="w"> </span><span class="o">+</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="n">__syscall_slong_t</span><span class="p">)(</span><span class="n">cycleTimeInMsec</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">MILLI_SECONDS</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">userAppWakeupPercentage</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">nanoSecondFieldConversion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nextnanosleeptimeUserApplication</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="o">*</span><span class="n">pubCounterData</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="n">UA_Int32</span><span class="w"> </span><span class="n">iterator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">iterator</span><span class="w"> </span><span class="o">&lt;</span><span class="w">  </span><span class="n">REPEATED_NODECOUNTS</span><span class="p">;</span><span class="w"> </span><span class="n">iterator</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="o">*</span><span class="n">repeatedCounterData</span><span class="p">[</span><span class="n">iterator</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">repeatedCounterValue</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="cp">#if defined(PUBLISHER) &amp;&amp; defined(SUBSCRIBER)</span>
<span class="w">    </span><span class="k">while</span><span class="p">(</span><span class="o">*</span><span class="n">runningPub</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">*</span><span class="n">runningSub</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">    </span><span class="k">while</span><span class="p">(</span><span class="o">*</span><span class="n">runningPub</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">        </span><span class="cm">/* The User application threads wakes up at the configured userApp wake</span>
<span class="cm">         * up percentage (30%) of each cycle */</span><span class="w"></span>
<span class="w">        </span><span class="n">clock_nanosleep</span><span class="p">(</span><span class="n">CLOCKID</span><span class="p">,</span><span class="w"> </span><span class="n">TIMER_ABSTIME</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">nextnanosleeptimeUserApplication</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span><span class="w"></span>
<span class="cp">#if defined(PUBLISHER)</span>
<span class="w">        </span><span class="cm">/* Increment the counter data and repeated counter data for the next cycle publish */</span><span class="w"></span>
<span class="w">        </span><span class="o">*</span><span class="n">pubCounterData</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">pubCounterData</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="n">UA_Int32</span><span class="w"> </span><span class="n">iterator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">iterator</span><span class="w"> </span><span class="o">&lt;</span><span class="w">  </span><span class="n">REPEATED_NODECOUNTS</span><span class="p">;</span><span class="w"> </span><span class="n">iterator</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="o">*</span><span class="n">repeatedCounterData</span><span class="p">[</span><span class="n">iterator</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">repeatedCounterData</span><span class="p">[</span><span class="n">iterator</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="cm">/* Get the time - T1, time where the counter data and repeated counter</span>
<span class="cm">         * data gets incremented. As this application uses FPM, we do not</span>
<span class="cm">         * require explicit call of UA_Server_write() to write the counter</span>
<span class="cm">         * values to the Information model. Hence, we take publish T1 time</span>
<span class="cm">         * here. */</span><span class="w"></span>
<span class="w">        </span><span class="n">clock_gettime</span><span class="p">(</span><span class="n">CLOCKID</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">dataModificationTime</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>

<span class="cp">#if defined(SUBSCRIBER)</span>
<span class="w">        </span><span class="cm">/* Get the time - T8, time where subscribed varibles are read from the</span>
<span class="cm">         * Information model. At this point, the packet will be already</span>
<span class="cm">         * subscribed and written into the Information model. As this</span>
<span class="cm">         * application uses FPM, we do not require explicit call of</span>
<span class="cm">         * UA_Server_read() to read the subscribed value from the Information</span>
<span class="cm">         * model. Hence, we take subscribed T8 time here. */</span><span class="w"></span>
<span class="w">        </span><span class="n">clock_gettime</span><span class="p">(</span><span class="n">CLOCKID</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">dataReceiveTime</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>

<span class="w">        </span><span class="cm">/* Update the T1, T8 time with the counter data in the user defined</span>
<span class="cm">         * publisher and subscriber arrays. */</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">enableCsvLog</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">enableLatencyCsvLog</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">consolePrint</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="cp">#if defined(PUBLISHER)</span>
<span class="w">            </span><span class="n">updateMeasurementsPublisher</span><span class="p">(</span><span class="n">dataModificationTime</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">pubCounterData</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>

<span class="cp">#if defined(SUBSCRIBER)</span>
<span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="o">*</span><span class="n">subCounterData</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="n">updateMeasurementsSubscriber</span><span class="p">(</span><span class="n">dataReceiveTime</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">subCounterData</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="cm">/* Calculation of the next wake up time by adding the interval with the</span>
<span class="cm">         * previous wake up time. */</span><span class="w"></span>
<span class="w">        </span><span class="n">nextnanosleeptimeUserApplication</span><span class="p">.</span><span class="n">tv_nsec</span><span class="w"> </span><span class="o">+=</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="n">__syscall_slong_t</span><span class="p">)(</span><span class="n">cycleTimeInMsec</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">MILLI_SECONDS</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">nanoSecondFieldConversion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nextnanosleeptimeUserApplication</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="cp">#endif</span>
</pre></div>
</div>
</section>
<section id="thread-creation">
<h2>Thread creation<a class="headerlink" href="#thread-creation" title="Permalink to this heading">¶</a></h2>
<p>The threadcreation functionality creates thread with given threadpriority,
coreaffinity. The function returns the threadID of the newly created thread.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="n">pthread_t</span><span class="w"></span>
<span class="nf">threadCreation</span><span class="p">(</span><span class="n">UA_Int16</span><span class="w"> </span><span class="n">threadPriority</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">coreAffinity</span><span class="p">,</span><span class="w"></span>
<span class="w">               </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="kr">thread</span><span class="p">)(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">),</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">applicationName</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">serverConfig</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="cm">/* Core affinity set */</span><span class="w"></span>
<span class="w">    </span><span class="kt">cpu_set_t</span><span class="w">           </span><span class="n">cpuset</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">pthread_t</span><span class="w">           </span><span class="n">threadID</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">sched_param</span><span class="w">  </span><span class="n">schedParam</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_Int32</span><span class="w">         </span><span class="n">returnValue</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_Int32</span><span class="w">         </span><span class="n">errorSetAffinity</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="cm">/* Return the ID for thread */</span><span class="w"></span>
<span class="w">    </span><span class="n">threadID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pthread_self</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">schedParam</span><span class="p">.</span><span class="n">sched_priority</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">threadPriority</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">returnValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pthread_setschedparam</span><span class="p">(</span><span class="n">threadID</span><span class="p">,</span><span class="w"> </span><span class="n">SCHED_FIFO</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">schedParam</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">returnValue</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">UA_LOG_INFO</span><span class="p">(</span><span class="n">UA_Log_Stdout</span><span class="p">,</span><span class="w"> </span><span class="n">UA_LOGCATEGORY_USERLAND</span><span class="p">,</span><span class="s">&quot;pthread_setschedparam: failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">UA_LOG_INFO</span><span class="p">(</span><span class="n">UA_Log_Stdout</span><span class="p">,</span><span class="w"> </span><span class="n">UA_LOGCATEGORY_USERLAND</span><span class="p">,</span>\
<span class="w">                </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">pthread_setschedparam:%s Thread priority is %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span>\
<span class="w">                </span><span class="n">applicationName</span><span class="p">,</span><span class="w"> </span><span class="n">schedParam</span><span class="p">.</span><span class="n">sched_priority</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">CPU_ZERO</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpuset</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">CPU_SET</span><span class="p">(</span><span class="n">coreAffinity</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cpuset</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">errorSetAffinity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pthread_setaffinity_np</span><span class="p">(</span><span class="n">threadID</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">cpu_set_t</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cpuset</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">errorSetAffinity</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;pthread_setaffinity_np: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">strerror</span><span class="p">(</span><span class="n">errorSetAffinity</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">returnValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">threadID</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="kr">thread</span><span class="p">,</span><span class="w"> </span><span class="n">serverConfig</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">returnValue</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">UA_LOG_WARNING</span><span class="p">(</span><span class="n">UA_Log_Stdout</span><span class="p">,</span><span class="w"> </span><span class="n">UA_LOGCATEGORY_USERLAND</span><span class="p">,</span><span class="w"></span>
<span class="w">                       </span><span class="s">&quot;:%s Cannot create thread</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">applicationName</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">CPU_ISSET</span><span class="p">(</span><span class="n">coreAffinity</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cpuset</span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="n">UA_LOG_INFO</span><span class="p">(</span><span class="n">UA_Log_Stdout</span><span class="p">,</span><span class="w"> </span><span class="n">UA_LOGCATEGORY_USERLAND</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="s">&quot;%s CPU CORE: %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">applicationName</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="n">coreAffinity</span><span class="p">);</span><span class="w"></span>

<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="n">threadID</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="creation-of-nodes">
<h2>Creation of nodes<a class="headerlink" href="#creation-of-nodes" title="Permalink to this heading">¶</a></h2>
<p>The addServerNodes function is used to create the publisher and subscriber
nodes.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">addServerNodes</span><span class="p">(</span><span class="n">UA_Server</span><span class="w"> </span><span class="o">*</span><span class="n">server</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_NodeId</span><span class="w"> </span><span class="n">objectId</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_NodeId</span><span class="w"> </span><span class="n">newNodeId</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_ObjectAttributes</span><span class="w"> </span><span class="n">object</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="n">UA_ObjectAttributes_default</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">object</span><span class="p">.</span><span class="n">displayName</span><span class="w">                   </span><span class="o">=</span><span class="w"> </span><span class="n">UA_LOCALIZEDTEXT</span><span class="p">(</span><span class="s">&quot;en-US&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Counter Object&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_Server_addObjectNode</span><span class="p">(</span><span class="n">server</span><span class="p">,</span><span class="w"> </span><span class="n">UA_NODEID_NULL</span><span class="p">,</span><span class="w"></span>
<span class="w">                            </span><span class="n">UA_NODEID_NUMERIC</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">UA_NS0ID_OBJECTSFOLDER</span><span class="p">),</span><span class="w"></span>
<span class="w">                            </span><span class="n">UA_NODEID_NUMERIC</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">UA_NS0ID_ORGANIZES</span><span class="p">),</span><span class="w"></span>
<span class="w">                            </span><span class="n">UA_QUALIFIEDNAME</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Counter Object&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">UA_NODEID_NULL</span><span class="p">,</span><span class="w"></span>
<span class="w">                            </span><span class="n">object</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">objectId</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_VariableAttributes</span><span class="w"> </span><span class="n">publisherAttr</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">UA_VariableAttributes_default</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_UInt64</span><span class="w"> </span><span class="n">publishValue</span><span class="w">               </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">publisherAttr</span><span class="p">.</span><span class="n">accessLevel</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="n">UA_ACCESSLEVELMASK_READ</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">UA_ACCESSLEVELMASK_WRITE</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_Variant_setScalar</span><span class="p">(</span><span class="o">&amp;</span><span class="n">publisherAttr</span><span class="p">.</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">publishValue</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">UA_TYPES</span><span class="p">[</span><span class="n">UA_TYPES_UINT64</span><span class="p">]);</span><span class="w"></span>
<span class="w">    </span><span class="n">publisherAttr</span><span class="p">.</span><span class="n">displayName</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="n">UA_LOCALIZEDTEXT</span><span class="p">(</span><span class="s">&quot;en-US&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Publisher Counter&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">publisherAttr</span><span class="p">.</span><span class="n">dataType</span><span class="w">               </span><span class="o">=</span><span class="w"> </span><span class="n">UA_TYPES</span><span class="p">[</span><span class="n">UA_TYPES_UINT64</span><span class="p">].</span><span class="n">typeId</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">newNodeId</span><span class="w">                            </span><span class="o">=</span><span class="w"> </span><span class="n">UA_NODEID_STRING</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;PublisherCounter&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_Server_addVariableNode</span><span class="p">(</span><span class="n">server</span><span class="p">,</span><span class="w"> </span><span class="n">newNodeId</span><span class="p">,</span><span class="w"> </span><span class="n">objectId</span><span class="p">,</span><span class="w"></span>
<span class="w">                              </span><span class="n">UA_NODEID_NUMERIC</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">UA_NS0ID_HASCOMPONENT</span><span class="p">),</span><span class="w"></span>
<span class="w">                              </span><span class="n">UA_QUALIFIEDNAME</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Publisher Counter&quot;</span><span class="p">),</span><span class="w"></span>
<span class="w">                              </span><span class="n">UA_NODEID_NULL</span><span class="p">,</span><span class="w"> </span><span class="n">publisherAttr</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pubNodeID</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_VariableAttributes</span><span class="w"> </span><span class="n">subscriberAttr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UA_VariableAttributes_default</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_UInt64</span><span class="w"> </span><span class="n">subscribeValue</span><span class="w">             </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">subscriberAttr</span><span class="p">.</span><span class="n">accessLevel</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="n">UA_ACCESSLEVELMASK_READ</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">UA_ACCESSLEVELMASK_WRITE</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_Variant_setScalar</span><span class="p">(</span><span class="o">&amp;</span><span class="n">subscriberAttr</span><span class="p">.</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">subscribeValue</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">UA_TYPES</span><span class="p">[</span><span class="n">UA_TYPES_UINT64</span><span class="p">]);</span><span class="w"></span>
<span class="w">    </span><span class="n">subscriberAttr</span><span class="p">.</span><span class="n">displayName</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="n">UA_LOCALIZEDTEXT</span><span class="p">(</span><span class="s">&quot;en-US&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Subscriber Counter&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">subscriberAttr</span><span class="p">.</span><span class="n">dataType</span><span class="w">              </span><span class="o">=</span><span class="w"> </span><span class="n">UA_TYPES</span><span class="p">[</span><span class="n">UA_TYPES_UINT64</span><span class="p">].</span><span class="n">typeId</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">newNodeId</span><span class="w">                            </span><span class="o">=</span><span class="w"> </span><span class="n">UA_NODEID_STRING</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;SubscriberCounter&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_Server_addVariableNode</span><span class="p">(</span><span class="n">server</span><span class="p">,</span><span class="w"> </span><span class="n">newNodeId</span><span class="p">,</span><span class="w"> </span><span class="n">objectId</span><span class="p">,</span><span class="w"></span>
<span class="w">                              </span><span class="n">UA_NODEID_NUMERIC</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">UA_NS0ID_HASCOMPONENT</span><span class="p">),</span><span class="w"></span>
<span class="w">                              </span><span class="n">UA_QUALIFIEDNAME</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Subscriber Counter&quot;</span><span class="p">),</span><span class="w"></span>
<span class="w">                              </span><span class="n">UA_NODEID_NULL</span><span class="p">,</span><span class="w"> </span><span class="n">subscriberAttr</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">subNodeID</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="n">UA_Int32</span><span class="w"> </span><span class="n">iterator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">iterator</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">REPEATED_NODECOUNTS</span><span class="p">;</span><span class="w"> </span><span class="n">iterator</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">UA_VariableAttributes</span><span class="w"> </span><span class="n">repeatedNodePub</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UA_VariableAttributes_default</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">UA_UInt64</span><span class="w"> </span><span class="n">repeatedPublishValue</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">repeatedNodePub</span><span class="p">.</span><span class="n">accessLevel</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="n">UA_ACCESSLEVELMASK_READ</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">UA_ACCESSLEVELMASK_WRITE</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">UA_Variant_setScalar</span><span class="p">(</span><span class="o">&amp;</span><span class="n">repeatedNodePub</span><span class="p">.</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">repeatedPublishValue</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">UA_TYPES</span><span class="p">[</span><span class="n">UA_TYPES_UINT64</span><span class="p">]);</span><span class="w"></span>
<span class="w">        </span><span class="n">repeatedNodePub</span><span class="p">.</span><span class="n">displayName</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="n">UA_LOCALIZEDTEXT</span><span class="p">(</span><span class="s">&quot;en-US&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Publisher RepeatedCounter&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">repeatedNodePub</span><span class="p">.</span><span class="n">dataType</span><span class="w">              </span><span class="o">=</span><span class="w"> </span><span class="n">UA_TYPES</span><span class="p">[</span><span class="n">UA_TYPES_UINT64</span><span class="p">].</span><span class="n">typeId</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">newNodeId</span><span class="w">                             </span><span class="o">=</span><span class="w"> </span><span class="n">UA_NODEID_NUMERIC</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">UA_UInt32</span><span class="p">)</span><span class="n">iterator</span><span class="o">+</span><span class="mi">10000</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">UA_Server_addVariableNode</span><span class="p">(</span><span class="n">server</span><span class="p">,</span><span class="w"> </span><span class="n">newNodeId</span><span class="p">,</span><span class="w"> </span><span class="n">objectId</span><span class="p">,</span><span class="w"></span>
<span class="w">                                 </span><span class="n">UA_NODEID_NUMERIC</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">UA_NS0ID_HASCOMPONENT</span><span class="p">),</span><span class="w"></span>
<span class="w">                                 </span><span class="n">UA_QUALIFIEDNAME</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Publisher RepeatedCounter&quot;</span><span class="p">),</span><span class="w"></span>
<span class="w">                                 </span><span class="n">UA_NODEID_NULL</span><span class="p">,</span><span class="w"> </span><span class="n">repeatedNodePub</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pubRepeatedCountNodeID</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_VariableAttributes</span><span class="w"> </span><span class="n">runningStatusPub</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UA_VariableAttributes_default</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_Boolean</span><span class="w"> </span><span class="n">runningPubStatus</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">runningStatusPub</span><span class="p">.</span><span class="n">accessLevel</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="n">UA_ACCESSLEVELMASK_READ</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">UA_ACCESSLEVELMASK_WRITE</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_Variant_setScalar</span><span class="p">(</span><span class="o">&amp;</span><span class="n">runningStatusPub</span><span class="p">.</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">runningPubStatus</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">UA_TYPES</span><span class="p">[</span><span class="n">UA_TYPES_BOOLEAN</span><span class="p">]);</span><span class="w"></span>
<span class="w">    </span><span class="n">runningStatusPub</span><span class="p">.</span><span class="n">displayName</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="n">UA_LOCALIZEDTEXT</span><span class="p">(</span><span class="s">&quot;en-US&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;RunningStatus Pub&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">runningStatusPub</span><span class="p">.</span><span class="n">dataType</span><span class="w">              </span><span class="o">=</span><span class="w"> </span><span class="n">UA_TYPES</span><span class="p">[</span><span class="n">UA_TYPES_BOOLEAN</span><span class="p">].</span><span class="n">typeId</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">newNodeId</span><span class="w">                              </span><span class="o">=</span><span class="w"> </span><span class="n">UA_NODEID_NUMERIC</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">UA_UInt32</span><span class="p">)</span><span class="mi">20000</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_Server_addVariableNode</span><span class="p">(</span><span class="n">server</span><span class="p">,</span><span class="w"> </span><span class="n">newNodeId</span><span class="p">,</span><span class="w"> </span><span class="n">objectId</span><span class="p">,</span><span class="w"></span>
<span class="w">                              </span><span class="n">UA_NODEID_NUMERIC</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">UA_NS0ID_HASCOMPONENT</span><span class="p">),</span><span class="w"></span>
<span class="w">                              </span><span class="n">UA_QUALIFIEDNAME</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;RunningStatus Pub&quot;</span><span class="p">),</span><span class="w"></span>
<span class="w">                              </span><span class="n">UA_NODEID_NULL</span><span class="p">,</span><span class="w"> </span><span class="n">runningStatusPub</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">runningPubStatusNodeID</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="n">UA_Int32</span><span class="w"> </span><span class="n">iterator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">iterator</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">REPEATED_NODECOUNTS</span><span class="p">;</span><span class="w"> </span><span class="n">iterator</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">UA_VariableAttributes</span><span class="w"> </span><span class="n">repeatedNodeSub</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UA_VariableAttributes_default</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">UA_UInt64</span><span class="w"> </span><span class="n">repeatedSubscribeValue</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">UA_Variant_setScalar</span><span class="p">(</span><span class="o">&amp;</span><span class="n">repeatedNodeSub</span><span class="p">.</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">repeatedSubscribeValue</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">UA_TYPES</span><span class="p">[</span><span class="n">UA_TYPES_UINT64</span><span class="p">]);</span><span class="w"></span>
<span class="w">        </span><span class="n">repeatedNodeSub</span><span class="p">.</span><span class="n">accessLevel</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="n">UA_ACCESSLEVELMASK_READ</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">UA_ACCESSLEVELMASK_WRITE</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">repeatedNodeSub</span><span class="p">.</span><span class="n">displayName</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="n">UA_LOCALIZEDTEXT</span><span class="p">(</span><span class="s">&quot;en-US&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Subscriber RepeatedCounter&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">repeatedNodeSub</span><span class="p">.</span><span class="n">dataType</span><span class="w">              </span><span class="o">=</span><span class="w"> </span><span class="n">UA_TYPES</span><span class="p">[</span><span class="n">UA_TYPES_UINT64</span><span class="p">].</span><span class="n">typeId</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">newNodeId</span><span class="w">                             </span><span class="o">=</span><span class="w"> </span><span class="n">UA_NODEID_NUMERIC</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">UA_UInt32</span><span class="p">)</span><span class="n">iterator</span><span class="o">+</span><span class="mi">50000</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">UA_Server_addVariableNode</span><span class="p">(</span><span class="n">server</span><span class="p">,</span><span class="w"> </span><span class="n">newNodeId</span><span class="p">,</span><span class="w"> </span><span class="n">objectId</span><span class="p">,</span><span class="w"></span>
<span class="w">                                 </span><span class="n">UA_NODEID_NUMERIC</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">UA_NS0ID_HASCOMPONENT</span><span class="p">),</span><span class="w"></span>
<span class="w">                                 </span><span class="n">UA_QUALIFIEDNAME</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Subscriber RepeatedCounter&quot;</span><span class="p">),</span><span class="w"></span>
<span class="w">                                 </span><span class="n">UA_NODEID_NULL</span><span class="p">,</span><span class="w"> </span><span class="n">repeatedNodeSub</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">subRepeatedCountNodeID</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_VariableAttributes</span><span class="w"> </span><span class="n">runningStatusSubscriber</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UA_VariableAttributes_default</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_Boolean</span><span class="w"> </span><span class="n">runningSubStatusValue</span><span class="w">              </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">runningStatusSubscriber</span><span class="p">.</span><span class="n">accessLevel</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="n">UA_ACCESSLEVELMASK_READ</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">UA_ACCESSLEVELMASK_WRITE</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_Variant_setScalar</span><span class="p">(</span><span class="o">&amp;</span><span class="n">runningStatusSubscriber</span><span class="p">.</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">runningSubStatusValue</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">UA_TYPES</span><span class="p">[</span><span class="n">UA_TYPES_BOOLEAN</span><span class="p">]);</span><span class="w"></span>
<span class="w">    </span><span class="n">runningStatusSubscriber</span><span class="p">.</span><span class="n">displayName</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="n">UA_LOCALIZEDTEXT</span><span class="p">(</span><span class="s">&quot;en-US&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;RunningStatus Sub&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">runningStatusSubscriber</span><span class="p">.</span><span class="n">dataType</span><span class="w">              </span><span class="o">=</span><span class="w"> </span><span class="n">UA_TYPES</span><span class="p">[</span><span class="n">UA_TYPES_BOOLEAN</span><span class="p">].</span><span class="n">typeId</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">newNodeId</span><span class="w">                                     </span><span class="o">=</span><span class="w"> </span><span class="n">UA_NODEID_NUMERIC</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">UA_UInt32</span><span class="p">)</span><span class="mi">30000</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_Server_addVariableNode</span><span class="p">(</span><span class="n">server</span><span class="p">,</span><span class="w"> </span><span class="n">newNodeId</span><span class="p">,</span><span class="w"> </span><span class="n">objectId</span><span class="p">,</span><span class="w"></span>
<span class="w">                              </span><span class="n">UA_NODEID_NUMERIC</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">UA_NS0ID_HASCOMPONENT</span><span class="p">),</span><span class="w"></span>
<span class="w">                              </span><span class="n">UA_QUALIFIEDNAME</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;RunningStatus Sub&quot;</span><span class="p">),</span><span class="w"></span>
<span class="w">                              </span><span class="n">UA_NODEID_NULL</span><span class="p">,</span><span class="w"> </span><span class="n">runningStatusSubscriber</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">runningSubStatusNodeID</span><span class="p">);</span><span class="w"></span>

<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="deletion-of-nodes">
<h2>Deletion of nodes<a class="headerlink" href="#deletion-of-nodes" title="Permalink to this heading">¶</a></h2>
<p>The removeServerNodes function is used to delete the publisher and subscriber
nodes.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">removeServerNodes</span><span class="p">(</span><span class="n">UA_Server</span><span class="w"> </span><span class="o">*</span><span class="n">server</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="cm">/* Delete the Publisher Counter Node*/</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_Server_deleteNode</span><span class="p">(</span><span class="n">server</span><span class="p">,</span><span class="w"> </span><span class="n">pubNodeID</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_NodeId_clear</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pubNodeID</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="n">UA_Int32</span><span class="w"> </span><span class="n">iterator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">iterator</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">REPEATED_NODECOUNTS</span><span class="p">;</span><span class="w"> </span><span class="n">iterator</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">UA_Server_deleteNode</span><span class="p">(</span><span class="n">server</span><span class="p">,</span><span class="w"> </span><span class="n">pubRepeatedCountNodeID</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">UA_NodeId_clear</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pubRepeatedCountNodeID</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_Server_deleteNode</span><span class="p">(</span><span class="n">server</span><span class="p">,</span><span class="w"> </span><span class="n">runningPubStatusNodeID</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_NodeId_clear</span><span class="p">(</span><span class="o">&amp;</span><span class="n">runningPubStatusNodeID</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">UA_Server_deleteNode</span><span class="p">(</span><span class="n">server</span><span class="p">,</span><span class="w"> </span><span class="n">subNodeID</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_NodeId_clear</span><span class="p">(</span><span class="o">&amp;</span><span class="n">subNodeID</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="n">UA_Int32</span><span class="w"> </span><span class="n">iterator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">iterator</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">REPEATED_NODECOUNTS</span><span class="p">;</span><span class="w"> </span><span class="n">iterator</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">UA_Server_deleteNode</span><span class="p">(</span><span class="n">server</span><span class="p">,</span><span class="w"> </span><span class="n">subRepeatedCountNodeID</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">UA_NodeId_clear</span><span class="p">(</span><span class="o">&amp;</span><span class="n">subRepeatedCountNodeID</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_Server_deleteNode</span><span class="p">(</span><span class="n">server</span><span class="p">,</span><span class="w"> </span><span class="n">runningSubStatusNodeID</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_NodeId_clear</span><span class="p">(</span><span class="o">&amp;</span><span class="n">runningSubStatusNodeID</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="cp">#if defined (PUBLISHER) &amp;&amp; defined(SUBSCRIBER)</span>
</pre></div>
</div>
</section>
<section id="time-difference-calculation">
<h2>Time Difference Calculation<a class="headerlink" href="#time-difference-calculation" title="Permalink to this heading">¶</a></h2>
<p>This function is used to calculate the difference between the
publishertimestamp and subscribertimestamp and store the result.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"></span>
<span class="nf">timespec_diff</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">timespec</span><span class="w"> </span><span class="o">*</span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">timespec</span><span class="w"> </span><span class="o">*</span><span class="n">stop</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">timespec</span><span class="w"> </span><span class="o">*</span><span class="n">result</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="p">((</span><span class="n">stop</span><span class="o">-&gt;</span><span class="n">tv_nsec</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="o">-&gt;</span><span class="n">tv_nsec</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">result</span><span class="o">-&gt;</span><span class="n">tv_sec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stop</span><span class="o">-&gt;</span><span class="n">tv_sec</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="o">-&gt;</span><span class="n">tv_sec</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">result</span><span class="o">-&gt;</span><span class="n">tv_nsec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stop</span><span class="o">-&gt;</span><span class="n">tv_nsec</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="o">-&gt;</span><span class="n">tv_nsec</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1000000000</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">result</span><span class="o">-&gt;</span><span class="n">tv_sec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stop</span><span class="o">-&gt;</span><span class="n">tv_sec</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="o">-&gt;</span><span class="n">tv_sec</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">result</span><span class="o">-&gt;</span><span class="n">tv_nsec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stop</span><span class="o">-&gt;</span><span class="n">tv_nsec</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="o">-&gt;</span><span class="n">tv_nsec</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="latency-calculation">
<h2>Latency Calculation<a class="headerlink" href="#latency-calculation" title="Permalink to this heading">¶</a></h2>
<p>When the application is run with “-enableLatencyCsvLog” option, this function
gets executed. This function calculates latency by computing the
publishtimestamp and subscribetimestamp taking the counterdata as reference
and writes the result in a csv.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">computeLatencyAndGenerateCsv</span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">latencyFileName</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="cm">/* Character array of computed latency to write into a file */</span><span class="w"></span>
<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">latency_measurements</span><span class="p">[</span><span class="n">MAX_MEASUREMENTS_FILEWRITE</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">timespec</span><span class="w"> </span><span class="n">resultTime</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">latencyComputePubIndex</span><span class="p">,</span><span class="w"> </span><span class="n">latencyComputeSubIndex</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_Double</span><span class="w"> </span><span class="n">finalTime</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_UInt64</span><span class="w"> </span><span class="n">missed_counter</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_UInt64</span><span class="w"> </span><span class="n">repeated_counter</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_UInt64</span><span class="w"> </span><span class="n">latencyCharIndex</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_UInt64</span><span class="w"> </span><span class="n">prevLatencyCharIndex</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="cm">/* Create the latency file and include the headers */</span><span class="w"></span>
<span class="w">    </span><span class="kt">FILE</span><span class="w"> </span><span class="o">*</span><span class="n">fp_latency</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">fp_latency</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fopen</span><span class="p">(</span><span class="n">latencyFileName</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;w&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">latencyCharIndex</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="p">(</span><span class="n">UA_UInt64</span><span class="p">)</span><span class="n">sprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">latency_measurements</span><span class="p">[</span><span class="n">latencyCharIndex</span><span class="p">],</span><span class="w"></span>
<span class="w">                                           </span><span class="s">&quot;%s, %s, %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                                           </span><span class="s">&quot;LatencyRTT&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Missed Counters&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Repeated Counters&quot;</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="n">latencyComputePubIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">latencyComputeSubIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">         </span><span class="n">latencyComputePubIndex</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">measurementsPublisher</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">latencyComputeSubIndex</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">measurementsSubscriber</span><span class="p">;</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="cm">/* Compute RTT latency by equating counter values */</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">publishCounterValue</span><span class="p">[</span><span class="n">latencyComputePubIndex</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">subscribeCounterValue</span><span class="p">[</span><span class="n">latencyComputeSubIndex</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">timespec_diff</span><span class="p">(</span><span class="o">&amp;</span><span class="n">publishTimestamp</span><span class="p">[</span><span class="n">latencyComputePubIndex</span><span class="p">],</span><span class="w"> </span><span class="o">&amp;</span><span class="n">subscribeTimestamp</span><span class="p">[</span><span class="n">latencyComputeSubIndex</span><span class="p">],</span><span class="w"> </span><span class="o">&amp;</span><span class="n">resultTime</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">finalTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">UA_Double</span><span class="p">)((</span><span class="n">resultTime</span><span class="p">.</span><span class="n">tv_sec</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1000000000L</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">resultTime</span><span class="p">.</span><span class="n">tv_nsec</span><span class="p">))</span><span class="o">/</span><span class="mi">1000</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="n">latencyComputePubIndex</span><span class="o">++</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="n">latencyComputeSubIndex</span><span class="o">++</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="n">publishCounterValue</span><span class="p">[</span><span class="n">latencyComputePubIndex</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">subscribeCounterValue</span><span class="p">[</span><span class="n">latencyComputeSubIndex</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">timespec_diff</span><span class="p">(</span><span class="o">&amp;</span><span class="n">publishTimestamp</span><span class="p">[</span><span class="n">latencyComputePubIndex</span><span class="p">],</span><span class="w"> </span><span class="o">&amp;</span><span class="n">subscribeTimestamp</span><span class="p">[</span><span class="n">latencyComputeSubIndex</span><span class="p">],</span><span class="w"> </span><span class="o">&amp;</span><span class="n">resultTime</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">finalTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">UA_Double</span><span class="p">)((</span><span class="n">resultTime</span><span class="p">.</span><span class="n">tv_sec</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1000000000L</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">resultTime</span><span class="p">.</span><span class="n">tv_nsec</span><span class="p">))</span><span class="o">/</span><span class="mi">1000</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="n">missed_counter</span><span class="o">++</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="n">latencyComputePubIndex</span><span class="o">++</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="n">subscribeCounterValue</span><span class="p">[</span><span class="n">latencyComputeSubIndex</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">subscribeCounterValue</span><span class="p">[</span><span class="n">latencyComputeSubIndex</span><span class="p">])</span><span class="w"></span>
<span class="w">                </span><span class="n">repeated_counter</span><span class="o">++</span><span class="p">;</span><span class="w"></span>

<span class="w">            </span><span class="n">timespec_diff</span><span class="p">(</span><span class="o">&amp;</span><span class="n">publishTimestamp</span><span class="p">[</span><span class="n">latencyComputePubIndex</span><span class="p">],</span><span class="w"> </span><span class="o">&amp;</span><span class="n">subscribeTimestamp</span><span class="p">[</span><span class="n">latencyComputeSubIndex</span><span class="p">],</span><span class="w"> </span><span class="o">&amp;</span><span class="n">resultTime</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">finalTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">UA_Double</span><span class="p">)((</span><span class="n">resultTime</span><span class="p">.</span><span class="n">tv_sec</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1000000000L</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">resultTime</span><span class="p">.</span><span class="n">tv_nsec</span><span class="p">))</span><span class="o">/</span><span class="mi">1000</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="n">latencyComputeSubIndex</span><span class="o">++</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="p">(((</span><span class="n">latencyCharIndex</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">prevLatencyCharIndex</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">latencyCharIndex</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">MAX_MEASUREMENTS_FILEWRITE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">latencyCharIndex</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="p">(</span><span class="n">UA_UInt64</span><span class="p">)</span><span class="n">sprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">latency_measurements</span><span class="p">[</span><span class="n">latencyCharIndex</span><span class="p">],</span><span class="w"></span>
<span class="w">                                                   </span><span class="s">&quot;%0.3f, %lu, %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                                                   </span><span class="n">finalTime</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="n">missed_counter</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="n">repeated_counter</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">UA_LOG_WARNING</span><span class="p">(</span><span class="n">UA_Log_Stdout</span><span class="p">,</span><span class="w"> </span><span class="n">UA_LOGCATEGORY_USERLAND</span><span class="p">,</span><span class="w"></span>
<span class="w">                           </span><span class="s">&quot;Character array has been filled. Computation stopped and leading to latency csv generation&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="n">prevLatencyCharIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latencyCharIndex</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cm">/* Write into the latency file */</span><span class="w"></span>
<span class="w">    </span><span class="n">fwrite</span><span class="p">(</span><span class="o">&amp;</span><span class="n">latency_measurements</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="p">)</span><span class="n">prevLatencyCharIndex</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">fp_latency</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">fclose</span><span class="p">(</span><span class="n">fp_latency</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="cp">#endif</span>
</pre></div>
</div>
</section>
<section id="usage-function">
<h2>Usage function<a class="headerlink" href="#usage-function" title="Permalink to this heading">¶</a></h2>
<p>The usage function gives the information to run the application.</p>
<p><code class="docutils literal notranslate"><span class="pre">./bin/examples/pubsub_TSN_publisher</span> <span class="pre">-interface</span> <span class="pre">&lt;ethernet_interface&gt;</span></code> runs the application.</p>
<p>For more options, use ./bin/examples/pubsub_TSN_publisher -h.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">usage</span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">appname</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">        </span><span class="s">&quot;usage: %s [options]</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">        </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">        </span><span class="s">&quot; -interface       [name] Use network interface &#39;name&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">        </span><span class="s">&quot; -cycleTimeInMsec [num]  Cycle time in milli seconds (default %lf)</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">        </span><span class="s">&quot; -socketPriority  [num]  Set publisher SO_PRIORITY to (default %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">        </span><span class="s">&quot; -pubPriority     [num]  Publisher thread priority value (default %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">        </span><span class="s">&quot; -subPriority     [num]  Subscriber thread priority value (default %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">        </span><span class="s">&quot; -userAppPriority [num]  User application thread priority value (default %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">        </span><span class="s">&quot; -pubCore         [num]  Run on CPU for publisher (default %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">        </span><span class="s">&quot; -subCore         [num]  Run on CPU for subscriber (default %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">        </span><span class="s">&quot; -userAppCore     [num]  Run on CPU for userApplication (default %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">        </span><span class="s">&quot; -pubMacAddress   [name] Publisher Mac address (default %s - where 8 is the VLAN ID and 3 is the PCP)</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">        </span><span class="s">&quot; -subMacAddress   [name] Subscriber Mac address (default %s - where 8 is the VLAN ID and 3 is the PCP)</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">        </span><span class="s">&quot; -qbvOffset       [num]  QBV offset value (default %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">        </span><span class="s">&quot; -disableSoTxtime        Do not use SO_TXTIME</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">        </span><span class="s">&quot; -enableCsvLog           Experimental: To log the data in csv files. Support up to 1 million samples</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">        </span><span class="s">&quot; -enableLatencyCsvLog    Experimental: To compute and create RTT latency csv. Support up to 1 million samples</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">        </span><span class="s">&quot; -enableconsolePrint     Experimental: To print the data in console output. Support for higher cycle time</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">        </span><span class="s">&quot; -enableBlockingSocket   Run application with blocking socket option. While using blocking socket option need to</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">        </span><span class="s">&quot;                         run both the Publisher and Loopback application. Otherwise application will not terminate.</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">        </span><span class="s">&quot; -enableXdpSubscribe     Enable XDP feature for subscriber. XDP_COPY and XDP_FLAGS_SKB_MODE is used by default. Not recommended to be enabled along with blocking socket.</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">        </span><span class="s">&quot; -xdpQueue        [num]  XDP queue value (default %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">        </span><span class="s">&quot; -xdpFlagDrvMode         Use XDP in DRV mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">        </span><span class="s">&quot; -xdpBindFlagZeroCopy    Use Zero-Copy mode in XDP</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">        </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">appname</span><span class="p">,</span><span class="w"> </span><span class="n">DEFAULT_CYCLE_TIME</span><span class="p">,</span><span class="w"> </span><span class="n">DEFAULT_SOCKET_PRIORITY</span><span class="p">,</span><span class="w"> </span><span class="n">DEFAULT_PUB_SCHED_PRIORITY</span><span class="p">,</span><span class="w"> </span>\
<span class="w">        </span><span class="n">DEFAULT_SUB_SCHED_PRIORITY</span><span class="p">,</span><span class="w"> </span><span class="n">DEFAULT_USERAPPLICATION_SCHED_PRIORITY</span><span class="p">,</span><span class="w"> </span>\
<span class="w">        </span><span class="n">DEFAULT_PUB_CORE</span><span class="p">,</span><span class="w"> </span><span class="n">DEFAULT_SUB_CORE</span><span class="p">,</span><span class="w"> </span><span class="n">DEFAULT_USER_APP_CORE</span><span class="p">,</span><span class="w"> </span>\
<span class="w">        </span><span class="n">DEFAULT_PUBLISHING_MAC_ADDRESS</span><span class="p">,</span><span class="w"> </span><span class="n">DEFAULT_SUBSCRIBING_MAC_ADDRESS</span><span class="p">,</span><span class="w"> </span><span class="n">DEFAULT_QBV_OFFSET</span><span class="p">,</span><span class="w"> </span><span class="n">DEFAULT_XDP_QUEUE</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="main-server-code">
<h2>Main Server code<a class="headerlink" href="#main-server-code" title="Permalink to this heading">¶</a></h2>
<p>The main function contains publisher and subscriber threads running in
parallel.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">argv</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">signal</span><span class="p">(</span><span class="n">SIGINT</span><span class="p">,</span><span class="w"> </span><span class="n">stopHandler</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">signal</span><span class="p">(</span><span class="n">SIGTERM</span><span class="p">,</span><span class="w"> </span><span class="n">stopHandler</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">UA_Int32</span><span class="w">         </span><span class="n">returnValue</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_StatusCode</span><span class="w">    </span><span class="n">retval</span><span class="w">              </span><span class="o">=</span><span class="w"> </span><span class="n">UA_STATUSCODE_GOOD</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_Server</span><span class="w">       </span><span class="o">*</span><span class="n">server</span><span class="w">              </span><span class="o">=</span><span class="w"> </span><span class="n">UA_Server_new</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_ServerConfig</span><span class="w"> </span><span class="o">*</span><span class="n">config</span><span class="w">              </span><span class="o">=</span><span class="w"> </span><span class="n">UA_Server_getConfig</span><span class="p">(</span><span class="n">server</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kt">char</span><span class="w">            </span><span class="o">*</span><span class="n">interface</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_Int32</span><span class="w">         </span><span class="n">argInputs</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">UA_Int32</span><span class="w">         </span><span class="n">long_index</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">char</span><span class="w">            </span><span class="o">*</span><span class="n">progname</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">pthread_t</span><span class="w">        </span><span class="n">userThreadID</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="cm">/* Process the command line arguments */</span><span class="w"></span>
<span class="w">    </span><span class="n">progname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strrchr</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="sc">&#39;/&#39;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">progname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">progname</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">progname</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="w"></span>

<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">option</span><span class="w"> </span><span class="n">long_options</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="s">&quot;interface&quot;</span><span class="p">,</span><span class="w">            </span><span class="n">required_argument</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;a&#39;</span><span class="p">},</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="s">&quot;cycleTimeInMsec&quot;</span><span class="p">,</span><span class="w">      </span><span class="n">required_argument</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;b&#39;</span><span class="p">},</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="s">&quot;socketPriority&quot;</span><span class="p">,</span><span class="w">       </span><span class="n">required_argument</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;c&#39;</span><span class="p">},</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="s">&quot;pubPriority&quot;</span><span class="p">,</span><span class="w">          </span><span class="n">required_argument</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;d&#39;</span><span class="p">},</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="s">&quot;subPriority&quot;</span><span class="p">,</span><span class="w">          </span><span class="n">required_argument</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;e&#39;</span><span class="p">},</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="s">&quot;userAppPriority&quot;</span><span class="p">,</span><span class="w">      </span><span class="n">required_argument</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;f&#39;</span><span class="p">},</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="s">&quot;pubCore&quot;</span><span class="p">,</span><span class="w">              </span><span class="n">required_argument</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;g&#39;</span><span class="p">},</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="s">&quot;subCore&quot;</span><span class="p">,</span><span class="w">              </span><span class="n">required_argument</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;h&#39;</span><span class="p">},</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="s">&quot;userAppCore&quot;</span><span class="p">,</span><span class="w">          </span><span class="n">required_argument</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;i&#39;</span><span class="p">},</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="s">&quot;pubMacAddress&quot;</span><span class="p">,</span><span class="w">        </span><span class="n">required_argument</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;j&#39;</span><span class="p">},</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="s">&quot;subMacAddress&quot;</span><span class="p">,</span><span class="w">        </span><span class="n">required_argument</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;k&#39;</span><span class="p">},</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="s">&quot;qbvOffset&quot;</span><span class="p">,</span><span class="w">            </span><span class="n">required_argument</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;l&#39;</span><span class="p">},</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="s">&quot;disableSoTxtime&quot;</span><span class="p">,</span><span class="w">      </span><span class="n">no_argument</span><span class="p">,</span><span class="w">       </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;m&#39;</span><span class="p">},</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="s">&quot;enableCsvLog&quot;</span><span class="p">,</span><span class="w">         </span><span class="n">no_argument</span><span class="p">,</span><span class="w">       </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;n&#39;</span><span class="p">},</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="s">&quot;enableLatencyCsvLog&quot;</span><span class="p">,</span><span class="w">  </span><span class="n">no_argument</span><span class="p">,</span><span class="w">       </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;o&#39;</span><span class="p">},</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="s">&quot;enableconsolePrint&quot;</span><span class="p">,</span><span class="w">   </span><span class="n">no_argument</span><span class="p">,</span><span class="w">       </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;p&#39;</span><span class="p">},</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="s">&quot;enableBlockingSocket&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">no_argument</span><span class="p">,</span><span class="w">       </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;q&#39;</span><span class="p">},</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="s">&quot;xdpQueue&quot;</span><span class="p">,</span><span class="w">             </span><span class="n">required_argument</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;r&#39;</span><span class="p">},</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="s">&quot;xdpFlagDrvMode&quot;</span><span class="p">,</span><span class="w">       </span><span class="n">no_argument</span><span class="p">,</span><span class="w">       </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;s&#39;</span><span class="p">},</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="s">&quot;xdpBindFlagZeroCopy&quot;</span><span class="p">,</span><span class="w">  </span><span class="n">no_argument</span><span class="p">,</span><span class="w">       </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;t&#39;</span><span class="p">},</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="s">&quot;enableXdpSubscribe&quot;</span><span class="p">,</span><span class="w">   </span><span class="n">no_argument</span><span class="p">,</span><span class="w">       </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;u&#39;</span><span class="p">},</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="s">&quot;help&quot;</span><span class="p">,</span><span class="w">                 </span><span class="n">no_argument</span><span class="p">,</span><span class="w">       </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;v&#39;</span><span class="p">},</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="w">                      </span><span class="mi">0</span><span class="p">,</span><span class="w">                 </span><span class="mi">0</span><span class="p">,</span><span class="w">  </span><span class="mi">0</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">};</span><span class="w"></span>

<span class="w">    </span><span class="k">while</span><span class="p">((</span><span class="n">argInputs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getopt_long_only</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">long_options</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">long_index</span><span class="p">))</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">switch</span><span class="p">(</span><span class="n">argInputs</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="sc">&#39;a&#39;</span><span class="p">:</span><span class="w"></span>
<span class="w">                </span><span class="n">interface</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">optarg</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="sc">&#39;b&#39;</span><span class="p">:</span><span class="w"></span>
<span class="w">                </span><span class="n">cycleTimeInMsec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atof</span><span class="p">(</span><span class="n">optarg</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="sc">&#39;c&#39;</span><span class="p">:</span><span class="w"></span>
<span class="w">                </span><span class="n">socketPriority</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atoi</span><span class="p">(</span><span class="n">optarg</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="sc">&#39;d&#39;</span><span class="p">:</span><span class="w"></span>
<span class="w">                </span><span class="n">pubPriority</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atoi</span><span class="p">(</span><span class="n">optarg</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="sc">&#39;e&#39;</span><span class="p">:</span><span class="w"></span>
<span class="w">                </span><span class="n">subPriority</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atoi</span><span class="p">(</span><span class="n">optarg</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="sc">&#39;f&#39;</span><span class="p">:</span><span class="w"></span>
<span class="w">                </span><span class="n">userAppPriority</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atoi</span><span class="p">(</span><span class="n">optarg</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="sc">&#39;g&#39;</span><span class="p">:</span><span class="w"></span>
<span class="w">                </span><span class="n">pubCore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atoi</span><span class="p">(</span><span class="n">optarg</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="sc">&#39;h&#39;</span><span class="p">:</span><span class="w"></span>
<span class="w">                </span><span class="n">subCore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atoi</span><span class="p">(</span><span class="n">optarg</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="sc">&#39;i&#39;</span><span class="p">:</span><span class="w"></span>
<span class="w">                </span><span class="n">userAppCore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atoi</span><span class="p">(</span><span class="n">optarg</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="sc">&#39;j&#39;</span><span class="p">:</span><span class="w"></span>
<span class="w">                </span><span class="n">pubMacAddress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">optarg</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="sc">&#39;k&#39;</span><span class="p">:</span><span class="w"></span>
<span class="w">                </span><span class="n">subMacAddress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">optarg</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="sc">&#39;l&#39;</span><span class="p">:</span><span class="w"></span>
<span class="w">                </span><span class="n">qbvOffset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atoi</span><span class="p">(</span><span class="n">optarg</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="sc">&#39;m&#39;</span><span class="p">:</span><span class="w"></span>
<span class="w">                </span><span class="n">disableSoTxtime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="sc">&#39;n&#39;</span><span class="p">:</span><span class="w"></span>
<span class="w">                </span><span class="n">enableCsvLog</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="sc">&#39;o&#39;</span><span class="p">:</span><span class="w"></span>
<span class="w">                </span><span class="n">enableLatencyCsvLog</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="sc">&#39;p&#39;</span><span class="p">:</span><span class="w"></span>
<span class="w">                </span><span class="n">consolePrint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="sc">&#39;q&#39;</span><span class="p">:</span><span class="w"></span>
<span class="w">                 </span><span class="cm">/* TODO: Application need to be exited independently */</span><span class="w"></span>
<span class="w">                </span><span class="n">enableBlockingSocket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="sc">&#39;r&#39;</span><span class="p">:</span><span class="w"></span>
<span class="w">                </span><span class="n">xdpQueue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">UA_UInt32</span><span class="p">)</span><span class="n">atoi</span><span class="p">(</span><span class="n">optarg</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="sc">&#39;s&#39;</span><span class="p">:</span><span class="w"></span>
<span class="w">                </span><span class="n">xdpFlag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">XDP_FLAGS_DRV_MODE</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="sc">&#39;t&#39;</span><span class="p">:</span><span class="w"></span>
<span class="w">                </span><span class="n">xdpBindFlag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">XDP_ZEROCOPY</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="sc">&#39;u&#39;</span><span class="p">:</span><span class="w"></span>
<span class="w">                </span><span class="n">enableXdpSubscribe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="sc">&#39;v&#39;</span><span class="p">:</span><span class="w"></span>
<span class="w">                </span><span class="n">usage</span><span class="p">(</span><span class="n">progname</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="sc">&#39;?&#39;</span><span class="p">:</span><span class="w"></span>
<span class="w">                </span><span class="n">usage</span><span class="p">(</span><span class="n">progname</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">interface</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">UA_LOG_ERROR</span><span class="p">(</span><span class="n">UA_Log_Stdout</span><span class="p">,</span><span class="w"> </span><span class="n">UA_LOGCATEGORY_SERVER</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Need a network interface to run&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">usage</span><span class="p">(</span><span class="n">progname</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">cycleTimeInMsec</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.125</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">UA_LOG_ERROR</span><span class="p">(</span><span class="n">UA_Log_Stdout</span><span class="p">,</span><span class="w"> </span><span class="n">UA_LOGCATEGORY_SERVER</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%f Bad cycle time&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">cycleTimeInMsec</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">usage</span><span class="p">(</span><span class="n">progname</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">enableBlockingSocket</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">enableXdpSubscribe</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">UA_LOG_ERROR</span><span class="p">(</span><span class="n">UA_Log_Stdout</span><span class="p">,</span><span class="w"> </span><span class="n">UA_LOGCATEGORY_SERVER</span><span class="p">,</span><span class="w"></span>
<span class="w">                         </span><span class="s">&quot;Cannot enable blocking socket and xdp at the same time&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">usage</span><span class="p">(</span><span class="n">progname</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">xdpFlag</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">XDP_FLAGS_DRV_MODE</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">xdpBindFlag</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">XDP_ZEROCOPY</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">enableXdpSubscribe</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">false</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="n">UA_LOG_INFO</span><span class="p">(</span><span class="n">UA_Log_Stdout</span><span class="p">,</span><span class="w"> </span><span class="n">UA_LOGCATEGORY_SERVER</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="s">&quot;Flag enableXdpSubscribe is false, running application without XDP&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">UA_ServerConfig_setMinimal</span><span class="p">(</span><span class="n">config</span><span class="p">,</span><span class="w"> </span><span class="n">PORT_NUMBER</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="tutorial_pubsub_subscribe.html" class="btn btn-neutral float-left" title="Subscribing Fields" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="pubsub_TSN_loopback.html" class="btn btn-neutral float-right" title="Realtime Loopback Example" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2016, The open62541 authors.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>
<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Working with Publish/Subscribe &mdash; open62541 1.4.3 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="_static/graphviz.css?v=fd3f3429" />

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="_static/documentation_options.js?v=a68a9277"></script>
        <script src="_static/doctools.js?v=9a2dae69"></script>
        <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Subscribing Fields" href="tutorial_pubsub_subscribe.html" />
    <link rel="prev" title="Building a Simple Client" href="tutorial_client_firststeps.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="toc.html" class="icon icon-home">
            open62541
              <img src="_static/open62541_html.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                1.4
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="index.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="core_concepts.html">Core Concepts of OPC UA</a></li>
<li class="toctree-l1"><a class="reference internal" href="building.html">Building open62541</a></li>
<li class="toctree-l1"><a class="reference internal" href="types.html">Data Types</a></li>
<li class="toctree-l1"><a class="reference internal" href="server.html">Server</a></li>
<li class="toctree-l1"><a class="reference internal" href="client.html">Client</a></li>
<li class="toctree-l1"><a class="reference internal" href="pubsub.html">PubSub</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="tutorials.html">Tutorials</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="tutorial_datatypes.html">Working with Data Types</a></li>
<li class="toctree-l2"><a class="reference internal" href="tutorial_server_firststeps.html">Building a Simple Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="tutorial_server_variable.html">Adding Variables to a Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="tutorial_server_datasource.html">Connecting a Variable with a Physical Process</a></li>
<li class="toctree-l2"><a class="reference internal" href="tutorial_server_variabletype.html">Working with Variable Types</a></li>
<li class="toctree-l2"><a class="reference internal" href="tutorial_server_object.html">Working with Objects and Object Types</a></li>
<li class="toctree-l2"><a class="reference internal" href="tutorial_server_method.html">Adding Methods to Objects</a></li>
<li class="toctree-l2"><a class="reference internal" href="tutorial_server_monitoreditems.html">Observing Attributes with Local MonitoredItems</a></li>
<li class="toctree-l2"><a class="reference internal" href="tutorial_server_events.html">Generating events</a></li>
<li class="toctree-l2"><a class="reference internal" href="tutorial_server_alarms_conditions.html">Using Alarms and Conditions Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="tutorial_client_firststeps.html">Building a Simple Client</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Working with Publish/Subscribe</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#publishing-fields">Publishing Fields</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="tutorial_pubsub_subscribe.html">Subscribing Fields</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="common.html">Common Definitions</a></li>
<li class="toctree-l1"><a class="reference internal" href="nodeset_compiler.html">XML Nodeset Compiler</a></li>
<li class="toctree-l1"><a class="reference internal" href="statuscodes.html">StatusCodes</a></li>
<li class="toctree-l1"><a class="reference internal" href="plugin.html">Plugin API</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="toc.html">open62541</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="toc.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="tutorials.html">Tutorials</a></li>
      <li class="breadcrumb-item active">Working with Publish/Subscribe</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/tutorial_pubsub_publish.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="working-with-publish-subscribe">
<span id="pubsub-tutorial"></span><h1>Working with Publish/Subscribe<a class="headerlink" href="#working-with-publish-subscribe" title="Link to this heading">¶</a></h1>
<p>Work in progress: This Tutorial will be continuously extended during the next
PubSub batches. More details about the PubSub extension and corresponding
open62541 API are located here: <a class="reference internal" href="pubsub.html#pubsub"><span class="std std-ref">PubSub</span></a>.</p>
<section id="publishing-fields">
<h2>Publishing Fields<a class="headerlink" href="#publishing-fields" title="Link to this heading">¶</a></h2>
<p>The PubSub publish example demonstrates the simplest way to publish
information from the information model over UDP multicast using the UADP
encoding.</p>
<p><strong>Connection handling</strong></p>
<p>PubSubConnections can be created and deleted on runtime. More details about
the system preconfiguration and connection can be found in
<code class="docutils literal notranslate"><span class="pre">tutorial_pubsub_connection.c</span></code>.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;open62541/plugin/log_stdout.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;open62541/server.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;open62541/server_pubsub.h&gt;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span>

<span class="n">UA_NodeId</span><span class="w"> </span><span class="n">connectionIdent</span><span class="p">,</span><span class="w"> </span><span class="n">publishedDataSetIdent</span><span class="p">,</span><span class="w"> </span><span class="n">writerGroupIdent</span><span class="p">;</span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span>
<span class="nf">addPubSubConnection</span><span class="p">(</span><span class="n">UA_Server</span><span class="w"> </span><span class="o">*</span><span class="n">server</span><span class="p">,</span><span class="w"> </span><span class="n">UA_String</span><span class="w"> </span><span class="o">*</span><span class="n">transportProfile</span><span class="p">,</span>
<span class="w">                    </span><span class="n">UA_NetworkAddressUrlDataType</span><span class="w"> </span><span class="o">*</span><span class="n">networkAddressUrl</span><span class="p">){</span>
<span class="w">    </span><span class="cm">/* Details about the connection configuration and handling are located</span>
<span class="cm">     * in the pubsub connection tutorial */</span>
<span class="w">    </span><span class="n">UA_PubSubConnectionConfig</span><span class="w"> </span><span class="n">connectionConfig</span><span class="p">;</span>
<span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">connectionConfig</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">connectionConfig</span><span class="p">));</span>
<span class="w">    </span><span class="n">connectionConfig</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UA_STRING</span><span class="p">(</span><span class="s">&quot;UADP Connection 1&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">connectionConfig</span><span class="p">.</span><span class="n">transportProfileUri</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">transportProfile</span><span class="p">;</span>
<span class="w">    </span><span class="n">connectionConfig</span><span class="p">.</span><span class="n">enabled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UA_TRUE</span><span class="p">;</span>
<span class="w">    </span><span class="n">UA_Variant_setScalar</span><span class="p">(</span><span class="o">&amp;</span><span class="n">connectionConfig</span><span class="p">.</span><span class="n">address</span><span class="p">,</span><span class="w"> </span><span class="n">networkAddressUrl</span><span class="p">,</span>
<span class="w">                         </span><span class="o">&amp;</span><span class="n">UA_TYPES</span><span class="p">[</span><span class="n">UA_TYPES_NETWORKADDRESSURLDATATYPE</span><span class="p">]);</span>
<span class="w">    </span><span class="cm">/* Changed to static publisherId from random generation to identify</span>
<span class="cm">     * the publisher on Subscriber side */</span>
<span class="w">    </span><span class="n">connectionConfig</span><span class="p">.</span><span class="n">publisherIdType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UA_PUBLISHERIDTYPE_UINT16</span><span class="p">;</span>
<span class="w">    </span><span class="n">connectionConfig</span><span class="p">.</span><span class="n">publisherId</span><span class="p">.</span><span class="n">uint16</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2234</span><span class="p">;</span>
<span class="w">    </span><span class="n">UA_Server_addPubSubConnection</span><span class="p">(</span><span class="n">server</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">connectionConfig</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">connectionIdent</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>PublishedDataSet handling</strong></p>
<p>The PublishedDataSet (PDS) and PubSubConnection are the toplevel entities and
can exist alone. The PDS contains the collection of the published fields. All
other PubSub elements are directly or indirectly linked with the PDS or
connection.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kt">void</span>
<span class="nf">addPublishedDataSet</span><span class="p">(</span><span class="n">UA_Server</span><span class="w"> </span><span class="o">*</span><span class="n">server</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="cm">/* The PublishedDataSetConfig contains all necessary public</span>
<span class="cm">    * information for the creation of a new PublishedDataSet */</span>
<span class="w">    </span><span class="n">UA_PublishedDataSetConfig</span><span class="w"> </span><span class="n">publishedDataSetConfig</span><span class="p">;</span>
<span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">publishedDataSetConfig</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">UA_PublishedDataSetConfig</span><span class="p">));</span>
<span class="w">    </span><span class="n">publishedDataSetConfig</span><span class="p">.</span><span class="n">publishedDataSetType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UA_PUBSUB_DATASET_PUBLISHEDITEMS</span><span class="p">;</span>
<span class="w">    </span><span class="n">publishedDataSetConfig</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UA_STRING</span><span class="p">(</span><span class="s">&quot;Demo PDS&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="cm">/* Create new PublishedDataSet based on the PublishedDataSetConfig. */</span>
<span class="w">    </span><span class="n">UA_Server_addPublishedDataSet</span><span class="p">(</span><span class="n">server</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">publishedDataSetConfig</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">publishedDataSetIdent</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>DataSetField handling</strong></p>
<p>The DataSetField (DSF) is part of the PDS and describes exactly one published
field.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kt">void</span>
<span class="nf">addDataSetField</span><span class="p">(</span><span class="n">UA_Server</span><span class="w"> </span><span class="o">*</span><span class="n">server</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="cm">/* Add a field to the previous created PublishedDataSet */</span>
<span class="w">    </span><span class="n">UA_NodeId</span><span class="w"> </span><span class="n">dataSetFieldIdent</span><span class="p">;</span>
<span class="w">    </span><span class="n">UA_DataSetFieldConfig</span><span class="w"> </span><span class="n">dataSetFieldConfig</span><span class="p">;</span>
<span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dataSetFieldConfig</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">UA_DataSetFieldConfig</span><span class="p">));</span>
<span class="w">    </span><span class="n">dataSetFieldConfig</span><span class="p">.</span><span class="n">dataSetFieldType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UA_PUBSUB_DATASETFIELD_VARIABLE</span><span class="p">;</span>
<span class="w">    </span><span class="n">dataSetFieldConfig</span><span class="p">.</span><span class="n">field</span><span class="p">.</span><span class="n">variable</span><span class="p">.</span><span class="n">fieldNameAlias</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UA_STRING</span><span class="p">(</span><span class="s">&quot;Server localtime&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">dataSetFieldConfig</span><span class="p">.</span><span class="n">field</span><span class="p">.</span><span class="n">variable</span><span class="p">.</span><span class="n">promotedField</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UA_FALSE</span><span class="p">;</span>
<span class="w">    </span><span class="n">dataSetFieldConfig</span><span class="p">.</span><span class="n">field</span><span class="p">.</span><span class="n">variable</span><span class="p">.</span><span class="n">publishParameters</span><span class="p">.</span><span class="n">publishedVariable</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="n">UA_NODEID_NUMERIC</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">UA_NS0ID_SERVER_SERVERSTATUS_CURRENTTIME</span><span class="p">);</span>
<span class="w">    </span><span class="n">dataSetFieldConfig</span><span class="p">.</span><span class="n">field</span><span class="p">.</span><span class="n">variable</span><span class="p">.</span><span class="n">publishParameters</span><span class="p">.</span><span class="n">attributeId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UA_ATTRIBUTEID_VALUE</span><span class="p">;</span>
<span class="w">    </span><span class="n">UA_Server_addDataSetField</span><span class="p">(</span><span class="n">server</span><span class="p">,</span><span class="w"> </span><span class="n">publishedDataSetIdent</span><span class="p">,</span>
<span class="w">                              </span><span class="o">&amp;</span><span class="n">dataSetFieldConfig</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">dataSetFieldIdent</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>WriterGroup handling</strong></p>
<p>The WriterGroup (WG) is part of the connection and contains the primary
configuration parameters for the message creation.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kt">void</span>
<span class="nf">addWriterGroup</span><span class="p">(</span><span class="n">UA_Server</span><span class="w"> </span><span class="o">*</span><span class="n">server</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="cm">/* Now we create a new WriterGroupConfig and add the group to the existing</span>
<span class="cm">     * PubSubConnection. */</span>
<span class="w">    </span><span class="n">UA_WriterGroupConfig</span><span class="w"> </span><span class="n">writerGroupConfig</span><span class="p">;</span>
<span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">writerGroupConfig</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">UA_WriterGroupConfig</span><span class="p">));</span>
<span class="w">    </span><span class="n">writerGroupConfig</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UA_STRING</span><span class="p">(</span><span class="s">&quot;Demo WriterGroup&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">writerGroupConfig</span><span class="p">.</span><span class="n">publishingInterval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span>
<span class="w">    </span><span class="n">writerGroupConfig</span><span class="p">.</span><span class="n">enabled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UA_FALSE</span><span class="p">;</span>
<span class="w">    </span><span class="n">writerGroupConfig</span><span class="p">.</span><span class="n">writerGroupId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span>
<span class="w">    </span><span class="n">writerGroupConfig</span><span class="p">.</span><span class="n">encodingMimeType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UA_PUBSUB_ENCODING_UADP</span><span class="p">;</span>
<span class="w">    </span><span class="n">writerGroupConfig</span><span class="p">.</span><span class="n">messageSettings</span><span class="p">.</span><span class="n">encoding</span><span class="w">             </span><span class="o">=</span><span class="w"> </span><span class="n">UA_EXTENSIONOBJECT_DECODED</span><span class="p">;</span>
<span class="w">    </span><span class="n">writerGroupConfig</span><span class="p">.</span><span class="n">messageSettings</span><span class="p">.</span><span class="n">content</span><span class="p">.</span><span class="n">decoded</span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">UA_TYPES</span><span class="p">[</span><span class="n">UA_TYPES_UADPWRITERGROUPMESSAGEDATATYPE</span><span class="p">];</span>
<span class="w">    </span><span class="cm">/* The configuration flags for the messages are encapsulated inside the</span>
<span class="cm">     * message- and transport settings extension objects. These extension</span>
<span class="cm">     * objects are defined by the standard. e.g.</span>
<span class="cm">     * UadpWriterGroupMessageDataType */</span>
<span class="w">    </span><span class="n">UA_UadpWriterGroupMessageDataType</span><span class="w"> </span><span class="o">*</span><span class="n">writerGroupMessage</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">UA_UadpWriterGroupMessageDataType_new</span><span class="p">();</span>
<span class="w">    </span><span class="cm">/* Change message settings of writerGroup to send PublisherId,</span>
<span class="cm">     * WriterGroupId in GroupHeader and DataSetWriterId in PayloadHeader</span>
<span class="cm">     * of NetworkMessage */</span>
<span class="w">    </span><span class="n">writerGroupMessage</span><span class="o">-&gt;</span><span class="n">networkMessageContentMask</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">UA_UadpNetworkMessageContentMask</span><span class="p">)(</span><span class="n">UA_UADPNETWORKMESSAGECONTENTMASK_PUBLISHERID</span><span class="w"> </span><span class="o">|</span>
<span class="w">                                                              </span><span class="p">(</span><span class="n">UA_UadpNetworkMessageContentMask</span><span class="p">)</span><span class="n">UA_UADPNETWORKMESSAGECONTENTMASK_GROUPHEADER</span><span class="w"> </span><span class="o">|</span>
<span class="w">                                                              </span><span class="p">(</span><span class="n">UA_UadpNetworkMessageContentMask</span><span class="p">)</span><span class="n">UA_UADPNETWORKMESSAGECONTENTMASK_WRITERGROUPID</span><span class="w"> </span><span class="o">|</span>
<span class="w">                                                              </span><span class="p">(</span><span class="n">UA_UadpNetworkMessageContentMask</span><span class="p">)</span><span class="n">UA_UADPNETWORKMESSAGECONTENTMASK_PAYLOADHEADER</span><span class="p">);</span>
<span class="w">    </span><span class="n">writerGroupConfig</span><span class="p">.</span><span class="n">messageSettings</span><span class="p">.</span><span class="n">content</span><span class="p">.</span><span class="n">decoded</span><span class="p">.</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">writerGroupMessage</span><span class="p">;</span>
<span class="w">    </span><span class="n">UA_Server_addWriterGroup</span><span class="p">(</span><span class="n">server</span><span class="p">,</span><span class="w"> </span><span class="n">connectionIdent</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">writerGroupConfig</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">writerGroupIdent</span><span class="p">);</span>
<span class="w">    </span><span class="n">UA_Server_setWriterGroupOperational</span><span class="p">(</span><span class="n">server</span><span class="p">,</span><span class="w"> </span><span class="n">writerGroupIdent</span><span class="p">);</span>
<span class="w">    </span><span class="n">UA_UadpWriterGroupMessageDataType_delete</span><span class="p">(</span><span class="n">writerGroupMessage</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>DataSetWriter handling</strong></p>
<p>A DataSetWriter (DSW) is the glue between the WG and the PDS. The DSW is
linked to exactly one PDS and contains additional information for the
message generation.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kt">void</span>
<span class="nf">addDataSetWriter</span><span class="p">(</span><span class="n">UA_Server</span><span class="w"> </span><span class="o">*</span><span class="n">server</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="cm">/* We need now a DataSetWriter within the WriterGroup. This means we must</span>
<span class="cm">     * create a new DataSetWriterConfig and add call the addWriterGroup function. */</span>
<span class="w">    </span><span class="n">UA_NodeId</span><span class="w"> </span><span class="n">dataSetWriterIdent</span><span class="p">;</span>
<span class="w">    </span><span class="n">UA_DataSetWriterConfig</span><span class="w"> </span><span class="n">dataSetWriterConfig</span><span class="p">;</span>
<span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dataSetWriterConfig</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">UA_DataSetWriterConfig</span><span class="p">));</span>
<span class="w">    </span><span class="n">dataSetWriterConfig</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UA_STRING</span><span class="p">(</span><span class="s">&quot;Demo DataSetWriter&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">dataSetWriterConfig</span><span class="p">.</span><span class="n">dataSetWriterId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">62541</span><span class="p">;</span>
<span class="w">    </span><span class="n">dataSetWriterConfig</span><span class="p">.</span><span class="n">keyFrameCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span>
<span class="w">    </span><span class="n">UA_Server_addDataSetWriter</span><span class="p">(</span><span class="n">server</span><span class="p">,</span><span class="w"> </span><span class="n">writerGroupIdent</span><span class="p">,</span><span class="w"> </span><span class="n">publishedDataSetIdent</span><span class="p">,</span>
<span class="w">                               </span><span class="o">&amp;</span><span class="n">dataSetWriterConfig</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">dataSetWriterIdent</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>That’s it! You’re now publishing the selected fields. Open a packet
inspection tool of trust e.g. wireshark and take a look on the outgoing
packages. The following graphic figures out the packages created by this
tutorial.</p>
<figure class="align-default" style="width: 100%">
<img alt="OPC UA PubSub communication in wireshark" src="_images/ua-wireshark-pubsub.png" />
</figure>
<p>The open62541 subscriber API will be released later. If you want to process
the the datagrams, take a look on the <code class="docutils literal notranslate"><span class="pre">ua_network_pubsub_networkmessage.c</span></code>
which already contains the decoding code for UADP messages.</p>
<p>It follows the main server code, making use of the above definitions.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="n">UA_String</span><span class="w"> </span><span class="o">*</span><span class="n">transportProfile</span><span class="p">,</span>
<span class="w">               </span><span class="n">UA_NetworkAddressUrlDataType</span><span class="w"> </span><span class="o">*</span><span class="n">networkAddressUrl</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">UA_Server</span><span class="w"> </span><span class="o">*</span><span class="n">server</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UA_Server_new</span><span class="p">();</span>

<span class="w">    </span><span class="n">addPubSubConnection</span><span class="p">(</span><span class="n">server</span><span class="p">,</span><span class="w"> </span><span class="n">transportProfile</span><span class="p">,</span><span class="w"> </span><span class="n">networkAddressUrl</span><span class="p">);</span>
<span class="w">    </span><span class="n">addPublishedDataSet</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>
<span class="w">    </span><span class="n">addDataSetField</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>
<span class="w">    </span><span class="n">addWriterGroup</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>
<span class="w">    </span><span class="n">addDataSetWriter</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>

<span class="w">    </span><span class="n">UA_StatusCode</span><span class="w"> </span><span class="n">retval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UA_Server_runUntilInterrupt</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>

<span class="w">    </span><span class="n">UA_Server_delete</span><span class="p">(</span><span class="n">server</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">retval</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">UA_STATUSCODE_GOOD</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">EXIT_SUCCESS</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">EXIT_FAILURE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span>
<span class="nf">usage</span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">progname</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;usage: %s &lt;uri&gt; [device]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">progname</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">argv</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">UA_String</span><span class="w"> </span><span class="n">transportProfile</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="n">UA_STRING</span><span class="p">(</span><span class="s">&quot;http://opcfoundation.org/UA-Profile/Transport/pubsub-udp-uadp&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">UA_NetworkAddressUrlDataType</span><span class="w"> </span><span class="n">networkAddressUrl</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="p">{</span><span class="n">UA_STRING_NULL</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">UA_STRING</span><span class="p">(</span><span class="s">&quot;opc.udp://224.0.0.22:4840/&quot;</span><span class="p">)};</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">argc</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="s">&quot;-h&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">usage</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">EXIT_SUCCESS</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="s">&quot;opc.udp://&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">networkAddressUrl</span><span class="p">.</span><span class="n">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UA_STRING</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="s">&quot;opc.eth://&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">transportProfile</span><span class="w"> </span><span class="o">=</span>
<span class="w">                </span><span class="n">UA_STRING</span><span class="p">(</span><span class="s">&quot;http://opcfoundation.org/UA-Profile/Transport/pubsub-eth-uadp&quot;</span><span class="p">);</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">argc</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Error: UADP/ETH needs an interface name</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">EXIT_FAILURE</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="n">networkAddressUrl</span><span class="p">.</span><span class="n">networkInterface</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UA_STRING</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
<span class="w">            </span><span class="n">networkAddressUrl</span><span class="p">.</span><span class="n">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UA_STRING</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Error: unknown URI</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">EXIT_FAILURE</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">run</span><span class="p">(</span><span class="o">&amp;</span><span class="n">transportProfile</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">networkAddressUrl</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="tutorial_client_firststeps.html" class="btn btn-neutral float-left" title="Building a Simple Client" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="tutorial_pubsub_subscribe.html" class="btn btn-neutral float-right" title="Subscribing Fields" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright .</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>